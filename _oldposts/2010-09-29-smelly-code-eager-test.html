---
layout: post
title: "Smelly Code: Eager Test"
date: 2010-09-29
comments: true
tags: [  Unit Testing, lessions learned, Java, Smelly Code, Android ]
---

This post shows a common code smell in unit tests also mentioned in the <a href="http://books.google.com/books?id=y4JuQgAACAAJ&amp;dq=xunit+test+patterns&amp;hl=en&amp;ei=4TijTODyD4jDswauo7mKBQ&amp;sa=X&amp;oi=book_result&amp;ct=result&amp;resnum=1&amp;ved=0CCoQ6AEwAA">xunit test patterns book</a>, namely "<a href="http://xunitpatterns.com/Obscure%20Test.html#Eager Test">Eager tests</a>".<br /><br /><span class="Apple-style-span" style="font-size: x-large;">Original, smelly code</span><br /><pre class="brush: java; highlight:[9,10,12,14,18]">public void testSaveSession(){<br /> MockSession mockSession = new MockSession("Test");<br /> mockSession.addParticipant(devices.get(0));<br /> mockSession.setSessionStart(DateUtils.createDateInstance("15.05.2010 12:00:00"));<br /><br /> assertTrue(dao.saveSession(mockSession));<br /> assertTrue("The id should have been assigned", mockSession.getId() &gt; 0); <br /><br /> mockSession.setSessionEnd(DateUtils.createDateInstance("15.05.2010 13:00"));<br /> assertTrue(dao.saveSession(mockSession));<br /> assertTrue("The id should have been assigned", mockSession.getId() &gt; 0);<br /> assertNotNull("The date should have been assigned", mockSession.getSessionStart());<br /> <br /> Cursor participantCursor = mockContentResolver.query(Participant.CONTENT_URI, null, Participant.DEVICES_ID + "=? AND " + Participant.SESSIONS_ID + "=?", new String[]{String.valueOf(devices.get(0).getId()), String.valueOf(mockSession.getId())}, null);<br /><br /> assertNotNull(participantCursor);<br /> assertTrue(participantCursor.moveToFirst());<br /> assertEquals("There should be 1 session", 1, participantCursor.getCount());<br />}<br /></pre><br /><span class="Apple-style-span" style="font-size: x-large;">Objections and Comments</span><br />The unit test shown above is a typical example of an <b><a href="http://xunitpatterns.com/Obscure%20Test.html#Eager Test">eager test</a></b>. The problem is that the test case does not only cover a single functionality, but several ones.<br /><br /><b>Line 9, 10 - </b>The code modifies the originally stored object and sets another property and persists everything again to the DB. In <b>line 12</b>&nbsp;a verification on the correct storing/retrieving of that value is being done. This actually&nbsp;<b>verifies an update</b>&nbsp;and is therefore out of scope of the "saveSession" test. It should be<b>&nbsp;extracted</b>&nbsp;to another one.<br /><br /><b>Line 12-18 - </b>&nbsp;The ContentProvider is queried on whether the participants associated to the session in <b>line 3</b>&nbsp;have been persisted properly. Again, this should not be done in this test case.<br /><br /><span class="Apple-style-span" style="font-size: x-large;">Proposed Refactoring</span><br />A possible refactoring is to split the test case into different ones, by using the <a href="http://www.refactoring.com/catalog/extractMethod.html">Extract Method</a> refactoring. I came up with three of them.<br /><br />The first is for testing just the <b>save</b>&nbsp;operation. All it needs to do is to verify whether the object got the according id associated from the DB.<br /><pre class="brush:java">public void testSaveSession(){<br /> //setup<br /> MockSession mockSession = new MockSession("Test");<br /> mockSession.setType(SessionType.MEETING);<br /> mockSession.setSessionStart(DateUtils.createDateInstance("15.05.2010 12:00:00"));<br /> mockSession.setSessionEnd(DateUtils.createDateInstance("15.05.2010 12:10:00"));<br /> mockSession.setDurationSeconds(5000);<br /><br /> //exercise<br /> assertTrue(dao.saveSession(mockSession));<br /> <br /> //verify<br /> assertTrue("The id should have been assigned", mockSession.getId() &gt; 0);<br />}</pre><br />The next one is responsible for verifying the update operations. It checks whether the object is being updated correctly and - for instance - it doesn't create a new record in the DB.<br /><br /><pre class="brush:java; highlight:[14]">public void testUpdateSession(){<br /> //setup (by inserting a session which can be updated subsequently)<br /> MockSession mockSession = new MockSession("Test");<br /> mockSession.setType(SessionType.MEETING);<br /> mockSession.setSessionStart(DateUtils.createDateInstance("15.05.2010 12:00:00"));<br /> dao.saveSession(mockSession);<br /> <br /> //exercise (do the update operation)<br /> mockSession.setSessionEnd(DateUtils.createDateInstance("15.05.2010 12:10:00"));<br /> dao.saveSession(mockSession);<br /> <br /> //verify<br /> Session updatedSession = dao.readSessionById(mockSession.getId());<br /> assertSessionEquals(mockSession, updatedSession);<br />}</pre><br />Note, in <b>line 14</b>&nbsp;I've factored out the comparison of the session object into a custom helper method which looks as follows<br /><pre class="brush:java">/*<br /> * Utility method for comparing session objects<br /> */<br />private void assertSessionEquals(Session expected, Session actual){<br /> assertEquals("The session id should match", expected.getId(), actual.getId());<br /> assertEquals("The session start date should match", expected.getSessionStart(), actual.getSessionStart());<br /> assertEquals("The session end date should match", expected.getSessionEnd(), actual.getSessionEnd());<br /> assertEquals("The session duration should match", expected.getDurationSeconds(), actual.getDurationSeconds());<br /> assertEquals("The session type should match", expected.getType(), actual.getType());<br /> assertEquals("The number of participants should match", expected.getParticipants().size(), actual.getParticipants().size());<br />}<br /></pre><br />Finally, the last one tests the persisting of a session with participants.<br /><pre class="brush:java">public void testSaveSession_WithParticipants(){<br /> //setup<br /> MockSession mockSession = new MockSession("Test");<br /> mockSession.addParticipant(devices.get(0));<br /> mockSession.addParticipant(devices.get(1));<br /> <br /> //exercise<br /> dao.saveSession(mockSession);<br /> <br /> //verify (by bypassing the Dao and directly querying the ContentProvider/DB<br /> Cursor participantCursor = mockContentResolver.query(Participant.CONTENT_URI, null, Participant.SESSIONS_ID + "=?", new String[]{ String.valueOf(mockSession.getId())}, null);<br /> assertTrue("The participant cursor should contain some participants", participantCursor.moveToFirst());<br /> assertEquals("There should be exactly 2 participants", 2, participantCursor.getCount());<br />}</pre><br />The resulting code is much better organized, readable and consequently also more maintainable.<br /><br /><i><span class="Apple-style-span" style="font-size: small;">This is one of a series of "smelly code" posts. <a href="http://blog.js-development.com/2010/09/introducing-smellycode.html">Read more here</a> or find them on <a href="http://search.twitter.com/search?q=%23smellycode">Twitter</a>.</span></i>