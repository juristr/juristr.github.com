<!DOCTYPE html>
<html lang="en-us"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="generator" content="Hugo 0.53" />
	
	<link rel="shortcut icon" href="/assets/images/sitelogo.jpeg">
	
	<title>My Journey replacing Promises with RxJS | juri.dev</title>
	
	<meta name="description" content="Guest post by Dzahat Ushev describing how to convert a promise based solution to RxJS">
	
	
	<meta name="robots" content="index, follow">

	
	<meta name="author" content="Juri Strumpflohner">
	<link rel="me" href="https://profiles.google.com/104904743888756261987" />
	<link rel="publisher" href='https://plus.google.com/104904743888756261987' />
	<meta property="twitter:account_id" content="14407063" />


	
	<meta name="google-site-verification" content="0_vyoIaeMG1kXR0h-48gy3OaGl8xoiSJsFDxxCTIBMs" />
	<meta name="google-site-verification" content="AvmssSjl_nchNXIqBW8Agb_UjGqvvLP7HXSxBZ9d0cg" />

	
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@juristr" />
	<meta name="twitter:title" content="My Journey replacing Promises with RxJS" />
	
	<meta name="twitter:description" content="Guest post by Dzahat Ushev describing how to convert a promise based solution to RxJS" />
	

	
	<meta name="twitter:image:src" content="https://juristr.com/blog/assets/imgs/rx-to-promise-journey/rxjourney-bg.jpg" />
	

	
	<meta property="og:type" content="article" />
	<meta property="og:title" content="My Journey replacing Promises with RxJS" />
	
	<meta property="og:description" content="Guest post by Dzahat Ushev describing how to convert a promise based solution to RxJS" />
	
	
	<meta property="og:image" content="https://juristr.com/blog/assets/imgs/rx-to-promise-journey/rxjourney-bg.jpg" />
	
	<meta property="og:url" content="https://juristr.com/blog/2018/10/journey-promises-to-rxjs" />
	<meta property="og:site_name" content="juristr.com" />

	
	<link rel="alternate" type="application/rss+xml" title="Juri Strumpflohner" href="//feeds.feedburner.com/juristrumpflohner">
	

	
	<link href="/css/bootstrap.min.css" rel="stylesheet">

	
	
	<link href='//fonts.googleapis.com/css?family=Righteous|Roboto:400,700,900|Source+Code+Pro|Lora:400,700,400italic|Material+Icons'
	 rel='stylesheet' type='text/css'>
	

	

	
	
	
	<link rel="stylesheet" href="/scss/main.min.css" integrity="" media="screen">

	

	

	
	
	<link rel="stylesheet" href="/scss/article.min.css" integrity="" media="screen">
	

	
	
</head><body>
<header class="navbar-light bg-white fixed-top mediumnavigation nav-down">
    <div class="container">

        
        <div class="row justify-content-center align-items-center brandrow">

            <div class="col-lg-4 col-md-4 col-xs-12 d-none d-md-block hidden-xs customarea">
                <img src="/assets/images/gde.svg" style="height:23px">
                <a href="https://google-developers.appspot.com/community/experts/directory/profile/profile-juri_strumpflohner" style="
                    padding-left: 5px;
                    font-size: 15pt;
                ">GDE
                    for Web Tech</a>
                

            </div>

            <div class="col-lg-4 col-md-4  col-xs-12 text-center logoarea">
                <a class="navbar-brand" href="https://juristr.com/">
                    
                    <span style="font-family:Righteous;">juri.dev</span>
                    
                </a>
                
            </div>

            <div class="col-lg-4 col-md-4  col-xs-12 text-right d-none d-md-block">
                <a href="https://twitter.com/juristr" class="twitter-follow-button" data-show-count="true">Follow me!</a>
                <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            </div>

        </div>
        

        <div class="navarea">

            <nav class="navbar navbar-toggleable-sm">
                
                <div id="bs4navbar" class="navbar-collapse">
                    
                    <ul id="menu-top-menu" class="navbar-nav col-md-12 justify-content-center">
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/">Home</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/blog">Blog</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/categories">Collections</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/newsletter">Newsletter</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="https://github.com/juristr/ama">AMA</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/about">About Me</a>
                        </li>
                        
                    </ul>

                    
                </div>
            </nav>

        </div>

    </div>

</header>

    <div class="site-content">



<div class="container page-container">
    <div class="row">
        
        <div class="col-md-2 pl-0"><div class="share">
    <p>
        Share
    </p>
    <ul>
        <li>
            <a target="_blank" href="https://twitter.com/home?status=Check out this post by @juristr https%3a%2f%2fjuristr.com%2fblog%2f2018%2f10%2fjourney-promises-to-rxjs%2f">
                <svg class="svgIcon-use" width="29" height="29" viewbox="0 0 29 29">
                    <path d="M21.967 11.8c.018 5.93-4.607 11.18-11.177 11.18-2.172 0-4.25-.62-6.047-1.76l-.268.422-.038.5.186.013.168.012c.3.02.44.032.6.046 2.06-.026 3.95-.686 5.49-1.86l1.12-.85-1.4-.048c-1.57-.055-2.92-1.08-3.36-2.51l-.48.146-.05.5c.22.03.48.05.75.08.48-.02.87-.07 1.25-.15l2.33-.49-2.32-.49c-1.68-.35-2.91-1.83-2.91-3.55 0-.05 0-.01-.01.03l-.49-.1-.25.44c.63.36 1.35.57 2.07.58l1.7.04L7.4 13c-.978-.662-1.59-1.79-1.618-3.047a4.08 4.08 0 0 1 .524-1.8l-.825.07a12.188 12.188 0 0 0 8.81 4.515l.59.033-.06-.59v-.02c-.05-.43-.06-.63-.06-.87a3.617 3.617 0 0 1 6.27-2.45l.2.21.28-.06c1.01-.22 1.94-.59 2.73-1.09l-.75-.56c-.1.36-.04.89.12 1.36.23.68.58 1.13 1.17.85l-.21-.45-.42-.27c-.52.8-1.17 1.48-1.92 2L22 11l.016.28c.013.2.014.35 0 .52v.04zm.998.038c.018-.22.017-.417 0-.66l-.498.034.284.41a8.183 8.183 0 0 0 2.2-2.267l.97-1.48-1.6.755c.17-.08.3-.02.34.03a.914.914 0 0 1-.13-.292c-.1-.297-.13-.64-.1-.766l.36-1.254-1.1.695c-.69.438-1.51.764-2.41.963l.48.15a4.574 4.574 0 0 0-3.38-1.484 4.616 4.616 0 0 0-4.61 4.613c0 .29.02.51.08.984l.01.02.5-.06.03-.5c-3.17-.18-6.1-1.7-8.08-4.15l-.48-.56-.36.64c-.39.69-.62 1.48-.65 2.28.04 1.61.81 3.04 2.06 3.88l.3-.92c-.55-.02-1.11-.17-1.6-.45l-.59-.34-.14.67c-.02.08-.02.16 0 .24-.01 2.12 1.55 4.01 3.69 4.46l.1-.49-.1-.49c-.33.07-.67.12-1.03.14-.18-.02-.43-.05-.64-.07l-.76-.09.23.73c.57 1.84 2.29 3.14 4.28 3.21l-.28-.89a8.252 8.252 0 0 1-4.85 1.66c-.12-.01-.26-.02-.56-.05l-.17-.01-.18-.01L2.53 21l1.694 1.07a12.233 12.233 0 0 0 6.58 1.917c7.156 0 12.2-5.73 12.18-12.18l-.002.04z"></path>
                </svg>
            </a>
        </li>
        <li>
            <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjuristr.com%2fblog%2f2018%2f10%2fjourney-promises-to-rxjs%2f">
                <svg class="svgIcon-use" width="29" height="29" viewbox="0 0 29 29">
                    <path d="M16.39 23.61v-5.808h1.846a.55.55 0 0 0 .546-.48l.36-2.797a.551.551 0 0 0-.547-.62H16.39V12.67c0-.67.12-.813.828-.813h1.474a.55.55 0 0 0 .55-.55V8.803a.55.55 0 0 0-.477-.545c-.436-.06-1.36-.116-2.22-.116-2.5 0-4.13 1.62-4.13 4.248v1.513H10.56a.551.551 0 0 0-.55.55v2.797c0 .304.248.55.55.55h1.855v5.76c-4.172-.96-7.215-4.7-7.215-9.1 0-5.17 4.17-9.36 9.31-9.36 5.14 0 9.31 4.19 9.31 9.36 0 4.48-3.155 8.27-7.43 9.15M14.51 4C8.76 4 4.1 8.684 4.1 14.46c0 5.162 3.75 9.523 8.778 10.32a.55.55 0 0 0 .637-.543v-6.985a.551.551 0 0 0-.55-.55H11.11v-1.697h1.855a.55.55 0 0 0 .55-.55v-2.063c0-2.02 1.136-3.148 3.03-3.148.567 0 1.156.027 1.597.06v1.453h-.924c-1.363 0-1.93.675-1.93 1.912v1.78c0 .3.247.55.55.55h2.132l-.218 1.69H15.84c-.305 0-.55.24-.55.55v7.02c0 .33.293.59.623.54 5.135-.7 9.007-5.11 9.007-10.36C24.92 8.68 20.26 4 14.51 4"></path>
                </svg>
            </a>
        </li>
    </ul>
    
</div></div>
        
        <div class="col-md-9 col-md-offset-2 col-xs-12">
            <div class="mainheading">

                
                
                
                
                <div class="row post-top-meta">
                    
                        
                        <div class="col-md-2">
                            <img class="author-thumb" src="https://pbs.twimg.com/profile_images/915706383986823168/GVDwgIBt_400x400.jpg" alt="Dzhavat Ushev">
                        </div>
                        <div class="col-md-10">
                            <a class="link-dark" href="https://twitter.com/dzhavatushev">Dzhavat Ushev</a><a href="https://twitter.com/@dzhavatushev"
                                class="btn follow">Follow</a>
                            <span class="author-description">
                                Father, husband, front-end developer, who uses web technology to solve problems and improve people&rsquo;s lives.<br/>
                                <i>Guest writer on juristr.com</i>
                            </span>
                            
                        </div>
                    
                </div>
                
                
                
                

                <h1 class="posttitle">My Journey replacing Promises with RxJS</h1>
                
                <h2 class="article-subtitle">Guest post by Dzahat Ushev describing how to convert a promise based solution to RxJS</h2>
                
                <p>
                    <span class="post-date">
                        <time class="post-date">
                            Oct 1, 2018
                        </time></span>
                    <span class="dot"></span>
                    <span class="post-read">11 min read</span>
                </p>
            </div>

            
            
            

            
            <a href="https://egghead.io/courses/productive-git-for-developers" class="external-link" data-client="eggheadio" data-uid="url">
                <img src="/assets/images/banners/egghead-banner-productive-git.png" style="width:100%" />
            </a>
            

            
            <div class="article-post">
                

<div class="article-intro">
    In this post I‚Äôm going to tell you, step-by-step, how I used RxJS to refactor a method that was based on Promises.
</div>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9669473064376287" data-ad-slot="2496274486"
    data-ad-format="auto"></ins>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<figure class="image--wide">
    <img src="/blog/assets/imgs/rx-to-promise-journey/rxjourney-bg.jpg">
    <figcaption>Photo by rawpixel on Unsplash</figcaption>
</figure>

<div class="article-toc">
    <strong>Table of contents</strong>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#promise-land">Promise land</a></li>
<li><a href="#realizing-i-need-help">Realizing I need help</a></li>
<li><a href="#rxjs-land">RxJS land</a>
<ul>
<li><a href="#forkjoin"><code>forkJoin</code></a></li>
<li><a href="#pipe"><code>pipe</code></a></li>
<li><a href="#mergemap"><code>mergeMap</code></a></li>
<li><a href="#filter"><code>filter</code></a></li>
<li><a href="#concat"><code>concat</code></a></li>
<li><a href="#mergemap-again"><code>mergeMap</code> again</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul></li>
</ul>
</nav>
</div>

<blockquote>
<p>This is a guest post by <a href="https://twitter.com/dzhavatushev">Dzhavat Ushev</a>. He‚Äôs a front-end developer, who uses web technology to solve problems. I met Dzhavat at ngVikings in Helsinki this year! A couple of weeks ago I found him asking for help about an RxJS problem on Twitter and followed up on some discussions he had with others to solve his specific issue. That‚Äôs when I asked him to write down his learnings as a guest post. Enjoy üôÇ!</p>
</blockquote>

<p>Before diving in I‚Äôd like to give you some context and the reason for doing this refactoring.</p>

<p>I‚Äôm working on an Angular app that uses Microsoft‚Äôs Graph and SharePoint APIs to get/create/modify data. This means that we make a lot of requests. To do that we‚Äôre using the excellent <a href="https://angular.io/api/common/http/HttpClient"><code>HttpClient</code></a> service build into Angular. This makes it very easy for us to send a request by using methods like <code>get()</code>, <code>post()</code>, <code>patch()</code>, etc. One important detail, however, is the fact that all of these methods return Observables. Early on in the development of our app we decided to convert these Observables to Promises because we didn‚Äôt have much experience doing things ‚Äúreactively‚Äù. So we ended up treating all of the requests we‚Äôre making as Promises.</p>

<p>Then some time passed by and we got brave enough to try a bit of RxJS here and there but mostly related to handling <code>resize</code> and <code>scroll</code> events. Then a few months ago we realized that it was about time to ‚Äústop swimming against the stream‚Äù and embrace the idea of handling HTTP requests as Observables as well. So we‚Äôve been slowly refactoring our code towards using RxJS Observables.</p>

<p>One day, after submitting a new pull request, I got this comment in my code review:</p>

<figure class="image--medium">
  <img src="/blog/assets/imgs/rx-to-promise-journey/01.png">
</figure>

<p>Aaaand that‚Äôs where my adventure begins üôÇ</p>

<h2 id="promise-land">Promise land</h2>

<p>The method I was going to refactor looked pretty much like this. Let‚Äôs call it <code>createFolder</code> just for the sake of giving it a purpose.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">createFolder</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span> <span class="c1">// 1
</span><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">),</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">),</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
  <span class="p">])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;get-id&#39;</span><span class="p">))</span> <span class="c1">// 2
</span><span class="c1"></span>  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">id</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="c1">// 3
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="sb">`call-1-using-</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="sb">`call-2-using-</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;All done!&#39;</span><span class="p">))</span> <span class="c1">// 4
</span><span class="c1"></span>  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>As you can see, I‚Äôm making a bunch of request and all of them are treated as <code>Promise</code>s. Some are called in parallel, while others wait for a result to come in before calling them in sequence.</p>

<p>Here‚Äôs a brief overview of how the code works:</p>

<ol>
<li><code>Promise.all()</code> takes an array of <code>Promise</code>s and executes them all at once (in parallel). It will wait until all of them are resolved before continuing down the chain. In my case I‚Äôm making three simple requests. Once they are done, the code will continue to the first <code>then()</code> passing no response to it.</li>
<li>From the first <code>then()</code>, I‚Äôm returning another <code>Promise</code> that makes a request to get me a special <code>id</code> which I‚Äôm going to need later on. Once this request is done it will pass the value to the second <code>then()</code> in the chain.</li>
<li>Inside the second <code>then()</code> I have a simple <code>if</code> statement to check whether the <code>id</code> has some value. If it has, I‚Äôm returning two <code>Promise</code>s chained one after the other in order to run them in sequence. This introduced a bit of nesting but I was ok with that.</li>
<li>Finally, the last <code>then()</code> will wait for the requests to complete and it will log <code>'</code><code>All done!</code><code>'</code> to the console.</li>
</ol>

<p>Note: If the <code>id</code> value in step 3 doesn‚Äôt pass the <code>if</code> check, the code will immediately run the last <code>then()</code> in the chain resulting in <code>undefined</code> as a response.</p>

<p>At this point I thought for a moment and said to myself: ‚ÄúI can probably refactor this rather quickly by nesting Observables but that is surely not a proper way to do it. I have to find a better way that takes advantage of RxJS‚Äô build in operators. And I need to understand what every step is doing so I can apply this in other cases as well!‚Äù</p>

<h2 id="realizing-i-need-help">Realizing I need help</h2>

<p>As I mentioned above, I gained some experience working with RxJS but that is mostly related to a single Observable - a single request, a stream of <code>scroll</code>/<code>resize</code>/<code>click</code> events, etc. Here I not only needed to handle multiple Observables running in a specific order, but also use a bunch of operators that would keep the structure as flat as possible.</p>

<p>The first thing I did was to open <a href="https://rxjs-dev.firebaseapp.com/">the documentation</a> and browse through some of the operators. The examples there were easy to follow and understand. What I struggled with was gluing things together.</p>

<p>So I did what everybody should do in this situation - raised my hand and <a href="https://twitter.com/dzhavatushev/status/1039883556779175936?s=20">asked for help</a>!</p>

<p><blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr"><a href="https://twitter.com/hashtag/RxJS?src=hash&amp;ref_src=twsrc%5Etfw">#RxJS</a> help üôã‚Äç‚ôÇÔ∏èI have this moster function which uses Promises and need to refactor it to using observables instead. I know I can use <code>forkJoin</code> for replacing <code>Promise.all</code> but then how should I go about the rest w/ nesting too much. (Stackblitz <a href="https://t.co/SM89MUyfsR">https://t.co/SM89MUyfsR</a>) ‚ù§ <a href="https://t.co/WlMJGGa8Yz">pic.twitter.com/WlMJGGa8Yz</a></p>&mdash; Dzhavat Ushev (@dzhavatushev) <a href="https://twitter.com/dzhavatushev/status/1039883556779175936?ref_src=twsrc%5Etfw">September 12, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>I got some really helpful suggestions from <a href="https://twitter.com/chaos_monster">@chaos_monster</a> and <a href="https://twitter.com/elmd_">Dominic Elm</a> on Twitter. They pretty much solved the problem for me so the credit should fully go to them.</p>

<h2 id="rxjs-land">RxJS land</h2>

<p>After playing with the proposed solution (shown below) for some time I started to understand it. Everything made sense and I could follow the logic all the way through.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">createFolder</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">forkJoin</span><span class="p">([</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">),</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">),</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
  <span class="p">]).</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">mergeMap</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;get-id&#39;</span><span class="p">)),</span>
    <span class="nx">filter</span><span class="p">(</span><span class="nx">id</span> <span class="p">=&gt;</span> <span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
    <span class="nx">mergeMap</span><span class="p">(</span><span class="nx">id</span> <span class="p">=&gt;</span> <span class="nx">concat</span><span class="p">(</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="sb">`call-1-using-</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">),</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="sb">`call-2-using-</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
    <span class="p">))</span>
  <span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{},</span>
    <span class="nx">error</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">),</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;All done!&#39;</span><span class="p">)</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>So the rest of the post will be dedicated to explaining how the code works and how each part maps to the different parts of the <code>Promise</code> based method from the example in the beginning.</p>

<h3 id="forkjoin"><code>forkJoin</code></h3>

<p>This operator works pretty much the same way as <code>Promise.all()</code>. It accepts any number of Observables passed in directly or as an array. It will wait <strong>for all of them</strong> to complete and combine the last values they emitted.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">),</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">),</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1">// ¬è¬è‚Üë became ‚Üì
</span><span class="c1"></span>
<span class="nx">forkJoin</span><span class="p">([</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">),</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">),</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
<span class="p">])</span>
</code></pre></div>
<p>This was fairly easy!</p>

<p>Now, if I wanted to just make three requests and move on, I would have called <code>subscribe()</code> here passing to it <code>next()</code>, <code>error()</code> and <code>complete()</code> functions.</p>

<p>But since I wanted to do more, I had to do some extra work.</p>

<h3 id="pipe"><code>pipe</code></h3>

<p>This little fellow is quite useful.</p>

<p>Starting from v5.5, RxJS shipped ‚Äú<a href="https://github.com/ReactiveX/rxjs/blob/master/doc/pipeable-operators.md"><em>pipeable operators</em></a>‚Äù. Without going into too much details, a ‚Äúpipeable‚Äú operator is just a function that takes an Observable as an input, performs some action on it, and returns a new Observable as an output. This new Observable is then passed as an input to the next operator and so on until it eventually reaches the <code>subscribe()</code> method at the end.</p>

<p>The <code>pipe()</code> method is what makes this possible. It basically allows you to combine operators.</p>

<p>Let‚Äôs see how that solved my problem.</p>

<h3 id="mergemap"><code>mergeMap</code></h3>

<p>Things started to get serious. <code>mergeMap</code> (and it‚Äôs cousins) was one of those operators that no matter how much I read about, I still felt unsure when and how to use.</p>

<p>With that in mind, let me try to explain it.</p>

<p>In order for <code>mergeMap()</code> to work we actually need two Observables. Let‚Äôs call the first one ‚Äúsource‚Äù and the second one ‚Äùinner‚Äù. Every time the ‚Äúsource‚Äù observable emits a value, <code>mergeMap</code> will capture it, pass it on to the ‚Äúinner‚Äù observable and wait for the ‚Äúinner‚Äù observable to emit something. When it does, it will capture this new value and will merge it back to the ‚Äúsource‚Äù observable.</p>

<p>Applied to my case, it looked like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span> <span class="p">...</span> <span class="p">])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;get-id&#39;</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">id</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// use id ...
</span><span class="c1"></span>  <span class="p">});</span>

<span class="c1">// ¬è¬è‚Üë became ‚Üì
</span><span class="c1"></span>
<span class="nx">forkJoin</span><span class="p">([</span> <span class="p">...</span> <span class="p">])</span>
  <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">mergeMap</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;get-id&#39;</span><span class="p">))</span>
  <span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">id</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// use id ...
</span><span class="c1"></span>  <span class="p">});</span>
</code></pre></div>
<p>Whenever <code>forkJoin()</code> emits a value, <code>mergeMap()</code> will start a new request for getting an <code>id</code>. When the request is done and the the inner observable emits the <code>id</code>, <code>mergeMap()</code> will grab it and merge it back to <code>forkJoin()</code>. Since there are no more operators the <code>id</code> will be passed to <code>subscribe()</code>.</p>

<h3 id="filter"><code>filter</code></h3>

<p>The next step in the process was to handle the second <code>then()</code>. This step can be split into two parts. The first is the <code>if</code> check and the second is the two Promises that are returned in case the <code>if</code> check evaluates to <code>true</code>.</p>

<p>The first part can be handled quite easily by using the <code>filter()</code> operator.</p>

<p>This operator works the same way as the <code>filter()</code> method on arrays. Its purpose is to keep/discard values. It takes a function that evaluates each value emitted by the source Observable (in my case that is the Observable coming from <code>mergeMap()</code>). If the evaluation returns <code>true</code>, the value is emitted, if <code>false</code> the value stops there and is not passed to the output Observable.</p>

<p>With that in mind my code now looked like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span> <span class="p">...</span> <span class="p">])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;get-id&#39;</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">id</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// use id ...
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">});</span>

<span class="c1">// ¬è¬è‚Üë became ‚Üì
</span><span class="c1"></span>
<span class="nx">forkJoin</span><span class="p">([</span> <span class="p">...</span> <span class="p">])</span>
  <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">mergeMap</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;get-id&#39;</span><span class="p">)),</span>
    <span class="nx">filter</span><span class="p">(</span><span class="nx">id</span> <span class="p">=&gt;</span> <span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">id</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// use id ...
</span><span class="c1"></span>  <span class="p">});</span>
</code></pre></div>
<p>It‚Äôs worth mentioning here that the <code>next()</code> function inside <code>subscribe()</code> will receive the <code>id</code> value only if it passes through the <code>filter()</code>. In case the <code>id</code> doesn‚Äôt make it through the <code>filter()</code>, only the <code>complete()</code> function will be called.</p>

<h3 id="concat"><code>concat</code></h3>

<p>The second part of the second <code>then()</code> was about handling two requests running in sequence. The order was important that‚Äôs why I ended up using two Promises chained together. When the second Promise resolves, the last <code>then()</code> in the chain will be called and that‚Äôs how I knew that everything is done.</p>

<p>So in order to achieve this behavior of two requests executed in sequence, I ended up using <code>concat()</code>. According to the documentation:</p>

<blockquote>
<p>It concatenates multiple Observables together by sequentially emitting their values, one Observable after the other.</p>
</blockquote>

<p>Exactly what I was looking for!</p>

<p>The only problem was that the <code>concat()</code> is not an operator*, so I could not simply put it after <code>filter()</code>.</p>

<blockquote>
<p>There is actually a <a href="https://rxjs-dev.firebaseapp.com/api/operators/concat"><code>concat</code> operator</a> but it is deprecated.</p>
</blockquote>

<h3 id="mergemap-again"><code>mergeMap</code> again</h3>

<p>The trick was to use <code>mergeMap()</code> once again. This operator would wait for <code>filter()</code> to emit something, and when it does, it would take the value and pass it on to <code>concat()</code>. The <code>concat()</code> on the other hand will subscribe to the first observable and it will wait for it to emit something. When it does, the value will be send back to <code>mergeMap()</code>, which will merge it into the outer Observable, and from there on it will travel all the way down to <code>subscribe()</code>.</p>

<p>Put in practice:</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span> <span class="p">...</span> <span class="p">])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;get-id&#39;</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">id</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="sb">`call-1-using-</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="sb">`call-2-using-</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;All done!&#39;</span><span class="p">));</span>

<span class="c1">// ¬è¬è‚Üë became ‚Üì
</span><span class="c1"></span>
<span class="nx">forkJoin</span><span class="p">([</span> <span class="p">...</span> <span class="p">])</span>
  <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">mergeMap</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="s1">&#39;get-id&#39;</span><span class="p">)),</span>
    <span class="nx">filter</span><span class="p">(</span><span class="nx">id</span> <span class="p">=&gt;</span> <span class="nx">id</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
    <span class="nx">mergeMap</span><span class="p">(</span><span class="nx">id</span> <span class="p">=&gt;</span> <span class="nx">concat</span><span class="p">(</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="sb">`call-1-using-</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">),</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="sb">`call-2-using-</span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
    <span class="p">))</span>
  <span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span>
    <span class="nx">response</span> <span class="p">=&gt;</span> <span class="p">{},</span>
    <span class="nx">error</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">),</span>
    <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;All done!&#39;</span><span class="p">)</span>
  <span class="p">);</span>
</code></pre></div>
<p>The final <code>All done!</code> message will be printed to the <code>console</code> when both Observables inside <code>concat()</code> complete.</p>

<p>Again, one thing worth emphasizing here is that the second <code>mergeMap()</code> will not run if the <code>id</code> inside <code>filter()</code> doesn‚Äôt pass the condition. In that case you‚Äôll still see <code>All done!</code> printed to the console but that is because it is located inside the <code>complete()</code> callback which is always invoked. Two requests inside <code>concat()</code>, however, would never have been called. So keep that in mind.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Phew! That was a lot. And this doesn‚Äôt even cover what happens if a request fails. That‚Äôs something for you to try. It‚Äôs important so remember to handle that case.</p>

<p>I personally learned a few things here:</p>

<ul>
<li>Breaking a complicated problem down to smaller parts is important because they feel easier to solve.</li>
<li>Being stuck and not knowing how to solve a problem can be a good thing because it helps you realize that there‚Äôs an opportunity to learn and grow.</li>
<li>There‚Äôs no shame in asking for help. We should do it more often.</li>
<li>Sharing what we know can help someone. We should do it more often as well.</li>
<li>I‚Äôm probably over explaining some stuff üòÉ</li>
</ul>

<p>Have you had to make a similar refactor? How did you do it? How would you improve my solution? Post your comments below.</p>

<p>If you‚Äôve made it thus far, thank you for reading! Hope you learned something new.</p>

<p>Thanks to <a href="https://twitter.com/juristr">Juri</a> for reviewing this post (and encouraging me to write it in first place).</p>


				<hr />

				Questions? Thoughts? Hit me up <a href="https://twitter.com/juristr" target="_blank">on Twitter</a>
            </div>

            
            <div class="after-post-tags">
                <ul class="tags">
                    
                    <li>
                        <a href="/tags/rxjs">rxjs</a>
                    </li>
                    
                    <li>
                        <a href="/tags/guest-post">guest-post</a>
                    </li>
                    
                </ul>
            </div>
            

            <a href="https://egghead.io/instructors/juri-strumpflohner" class="external-link" data-client="eggheadio"
                data-uid="egghead-instructor-page">
                <img src="/blog/assets/imgs/egghead-banner-learn-with-me.png" style="width:100%" />
            </a>

            
            
            
        </div>
        
    </div>
</div>

<div class="hideshare"></div>



<div class="related-container">
    <div class="container">
        <div class="row listrecent listrelated">
            

        </div>
    </div>
</div>

<div class="container">
    <div id="comments" class="row justify-content-center mb-5">
        <div class="col-md-8">              
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "juristr" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>               
        </div>
    </div>
</div>



<script type="text/javascript" src="//downloads.mailchimp.com/js/signup-forms/popup/unique-methods/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script><script type="text/javascript">window.dojoRequire(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us4.list-manage.com","uuid":"04e83acc0ba14b18f30435204","lid":"1d83b68321","uniqueMethods":true}) })</script>
<div class="container">
    
<div class="footer">
    <p class="pull-left">
        &copy; Copyright Juri Strumpflohner - All rights reserved
    </p>
    <p class="pull-right">
        Customized Mediumish Theme, originally by <a target="_blank" href="https://www.wowthemes.net">WowThemes.net</a>
    </p>
    <div class="clearfix">
    </div>
</div>


</div>

    </div>

<script src="/js/jquery.min.js"></script>


<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-throttle-debounce/1.1/jquery.ba-throttle-debounce.min.js"></script>




<script type="text/javascript" src="/js/bundle.js" integrity=""></script>


<script src="/js/jquery.fluidbox.min.js"></script>
<script>
    $('a.image--zoom,.gallery>a').fluidbox();
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-416229-12', 'juristr.com');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
  </script>






    
    <script type="text/javascript">
        window.cookieconsent_options = {
            "message": "This website uses cookies to ensure you get the best experience on our website",
            "dismiss": "Got it!",
            "learnMore": "More info",
            "link": null,
            "theme": "dark-bottom"
        };
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js"></script>
    

    
    
    <script src="https://assets.digitalclimatestrike.net/widget.js" async></script>
</body>

</html>