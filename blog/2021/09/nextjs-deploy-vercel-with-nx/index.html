<!DOCTYPE html>
<html lang="en-us"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="generator" content="Hugo 0.53" />
	
	<link rel="shortcut icon" href="/assets/images/sitelogo.jpeg">
	
	<title>Publishing a Next.js app to Vercel with Nx | juri.dev</title>
	
	<meta name="description" content="Learn how to use Next.js, Nx and Tailwind together">
	
	
	<meta name="robots" content="index, follow">

	
	<meta name="author" content="Juri Strumpflohner">
	<link rel="me" href="https://profiles.google.com/104904743888756261987" />
	<link rel="publisher" href='https://plus.google.com/104904743888756261987' />
	<meta property="twitter:account_id" content="14407063" />


	
	<meta name="google-site-verification" content="0_vyoIaeMG1kXR0h-48gy3OaGl8xoiSJsFDxxCTIBMs" />
	<meta name="google-site-verification" content="AvmssSjl_nchNXIqBW8Agb_UjGqvvLP7HXSxBZ9d0cg" />

	
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@juristr" />
	<meta name="twitter:creator" content="@juristr" />
	<meta name="twitter:title" content="Publishing a Next.js app to Vercel with Nx" />
	
	<meta name="twitter:description" content="Learn how to use Next.js, Nx and Tailwind together" />
	

	
	<meta name="twitter:image:src" content="https://juristr.com/blog/assets/imgs/nextjs-nx-series/bg-deploy-vercel.jpg" />
	

	
	<meta property="og:type" content="article" />
	<meta property="og:title" content="Publishing a Next.js app to Vercel with Nx" />
	
	<meta property="og:description" content="Learn how to use Next.js, Nx and Tailwind together" />
	
	
	<meta property="og:image" content="https://juristr.com/blog/assets/imgs/nextjs-nx-series/bg-deploy-vercel.jpg" />
	
	<meta property="og:url" content="https://juristr.com/blog/2021/09/nextjs-deploy-vercel-with-nx" />
	<meta property="og:site_name" content="juristr.com" />

	
	<link rel="alternate" type="application/rss+xml" title="Juri Strumpflohner" href="//feeds.feedburner.com/juristrumpflohner">
	

	
	<link href="/css/bootstrap.min.css" rel="stylesheet">

	
	
	<link href='//fonts.googleapis.com/css?family=Righteous|Roboto:400,700,900|Source+Code+Pro|Lora:400,700,400italic|Material+Icons'
	 rel='stylesheet' type='text/css'>
	

	

	
	
	
	<link rel="stylesheet" href="/scss/main.min.css" integrity="" media="screen">

	

	

	
	
	<link rel="stylesheet" href="/scss/article.min.css" integrity="" media="screen">
	

	
	
	<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
<header class="navbar-light bg-white fixed-top mediumnavigation nav-down">
    <div class="container">

        
        <div class="row justify-content-center align-items-center brandrow">

            <div class="col-lg-4 col-md-4 col-xs-12 d-none d-md-block hidden-xs customarea">
                <img src="/assets/images/gde.svg" style="height:23px">
                <a href="https://developers.google.com/community/experts/directory/profile/profile-juri_strumpflohner" style="
                    padding-left: 5px;
                    font-size: 15pt;
                ">GDE
                    for Web Tech</a>
                

            </div>

            <div class="col-lg-4 col-md-4  col-xs-12 text-center logoarea">
                <a class="navbar-brand" href="https://juristr.com/">
                    
                    <span style="font-family:Righteous;">juri.dev</span>
                    
                </a>
                
            </div>

            <div class="col-lg-4 col-md-4  col-xs-12 text-right d-none d-md-block">
                <a href="https://twitter.com/juristr" class="twitter-follow-button" data-show-count="true">Follow me!</a>
                <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            </div>

        </div>
        

        <div class="navarea">

            <nav class="navbar navbar-toggleable-sm">
                
                <div id="bs4navbar" class="navbar-collapse">
                    
                    <ul id="menu-top-menu" class="navbar-nav col-md-12 justify-content-center">
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/">Home</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/blog">Blog</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/categories">Collections</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/newsletter">Newsletter</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="https://github.com/juristr/ama">AMA</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/about">About Me</a>
                        </li>
                        
                    </ul>

                    
                </div>
            </nav>

        </div>

    </div>

</header>

    <div class="site-content">



<div class="container page-container">
    <div class="row">
        
        <div class="col-md-2 pl-0"><div class="share">
    <p>
        Share
    </p>
    <ul>
        <li>
            <a target="_blank" href="https://twitter.com/home?status=Check out this post by @juristr https%3a%2f%2fjuristr.com%2fblog%2f2021%2f09%2fnextjs-deploy-vercel-with-nx%2f">
                <svg class="svgIcon-use" width="29" height="29" viewbox="0 0 29 29">
                    <path d="M21.967 11.8c.018 5.93-4.607 11.18-11.177 11.18-2.172 0-4.25-.62-6.047-1.76l-.268.422-.038.5.186.013.168.012c.3.02.44.032.6.046 2.06-.026 3.95-.686 5.49-1.86l1.12-.85-1.4-.048c-1.57-.055-2.92-1.08-3.36-2.51l-.48.146-.05.5c.22.03.48.05.75.08.48-.02.87-.07 1.25-.15l2.33-.49-2.32-.49c-1.68-.35-2.91-1.83-2.91-3.55 0-.05 0-.01-.01.03l-.49-.1-.25.44c.63.36 1.35.57 2.07.58l1.7.04L7.4 13c-.978-.662-1.59-1.79-1.618-3.047a4.08 4.08 0 0 1 .524-1.8l-.825.07a12.188 12.188 0 0 0 8.81 4.515l.59.033-.06-.59v-.02c-.05-.43-.06-.63-.06-.87a3.617 3.617 0 0 1 6.27-2.45l.2.21.28-.06c1.01-.22 1.94-.59 2.73-1.09l-.75-.56c-.1.36-.04.89.12 1.36.23.68.58 1.13 1.17.85l-.21-.45-.42-.27c-.52.8-1.17 1.48-1.92 2L22 11l.016.28c.013.2.014.35 0 .52v.04zm.998.038c.018-.22.017-.417 0-.66l-.498.034.284.41a8.183 8.183 0 0 0 2.2-2.267l.97-1.48-1.6.755c.17-.08.3-.02.34.03a.914.914 0 0 1-.13-.292c-.1-.297-.13-.64-.1-.766l.36-1.254-1.1.695c-.69.438-1.51.764-2.41.963l.48.15a4.574 4.574 0 0 0-3.38-1.484 4.616 4.616 0 0 0-4.61 4.613c0 .29.02.51.08.984l.01.02.5-.06.03-.5c-3.17-.18-6.1-1.7-8.08-4.15l-.48-.56-.36.64c-.39.69-.62 1.48-.65 2.28.04 1.61.81 3.04 2.06 3.88l.3-.92c-.55-.02-1.11-.17-1.6-.45l-.59-.34-.14.67c-.02.08-.02.16 0 .24-.01 2.12 1.55 4.01 3.69 4.46l.1-.49-.1-.49c-.33.07-.67.12-1.03.14-.18-.02-.43-.05-.64-.07l-.76-.09.23.73c.57 1.84 2.29 3.14 4.28 3.21l-.28-.89a8.252 8.252 0 0 1-4.85 1.66c-.12-.01-.26-.02-.56-.05l-.17-.01-.18-.01L2.53 21l1.694 1.07a12.233 12.233 0 0 0 6.58 1.917c7.156 0 12.2-5.73 12.18-12.18l-.002.04z"></path>
                </svg>
            </a>
        </li>
        <li>
            <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjuristr.com%2fblog%2f2021%2f09%2fnextjs-deploy-vercel-with-nx%2f">
                <svg class="svgIcon-use" width="29" height="29" viewbox="0 0 29 29">
                    <path d="M16.39 23.61v-5.808h1.846a.55.55 0 0 0 .546-.48l.36-2.797a.551.551 0 0 0-.547-.62H16.39V12.67c0-.67.12-.813.828-.813h1.474a.55.55 0 0 0 .55-.55V8.803a.55.55 0 0 0-.477-.545c-.436-.06-1.36-.116-2.22-.116-2.5 0-4.13 1.62-4.13 4.248v1.513H10.56a.551.551 0 0 0-.55.55v2.797c0 .304.248.55.55.55h1.855v5.76c-4.172-.96-7.215-4.7-7.215-9.1 0-5.17 4.17-9.36 9.31-9.36 5.14 0 9.31 4.19 9.31 9.36 0 4.48-3.155 8.27-7.43 9.15M14.51 4C8.76 4 4.1 8.684 4.1 14.46c0 5.162 3.75 9.523 8.778 10.32a.55.55 0 0 0 .637-.543v-6.985a.551.551 0 0 0-.55-.55H11.11v-1.697h1.855a.55.55 0 0 0 .55-.55v-2.063c0-2.02 1.136-3.148 3.03-3.148.567 0 1.156.027 1.597.06v1.453h-.924c-1.363 0-1.93.675-1.93 1.912v1.78c0 .3.247.55.55.55h2.132l-.218 1.69H15.84c-.305 0-.55.24-.55.55v7.02c0 .33.293.59.623.54 5.135-.7 9.007-5.11 9.007-10.36C24.92 8.68 20.26 4 14.51 4"></path>
                </svg>
            </a>
        </li>
    </ul>
    
</div></div>
        
        <div class="col-md-9 col-md-offset-2 col-xs-12">
            <div class="mainheading">

                
                
                
                
                <div class="row post-top-meta">
                    
                    <div class="col-md-2">
                        <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                    </div>
                    <div class="col-md-10">
                        <a class="link-dark" href="/about/">Juri Strumpflohner</a><a href="https://twitter.com/@juristr"
                            class="btn follow">Follow</a>
                        <span class="author-description">Juri is a full stack developer and tech lead with a special passion for the web and frontend development. He creates online videos for <a href="https://egghead.io/instructors/juri-strumpflohner">Egghead.io</a>, writes articles on his blog and for tech magazines, speaks at conferences and holds training workshops. Juri is also a recognized Google Developer Expert in Web Technologies</span>
                        
                    </div>
                    
                </div>
                
                
                
                

                <h1 class="posttitle">Publishing a Next.js app to Vercel with Nx</h1>
                
                <h2 class="article-subtitle">Learn how to use Next.js, Nx and Tailwind together</h2>
                
                <p>
                    <span class="post-date">
                        <time class="post-date">
                            Sep 14, 2021
                        </time></span>
                    <span class="dot"></span>
                    <span class="post-read">16 min read</span>
                </p>
            </div>

            
            
            

            
            <a href="https://egghead.io/courses/productive-git-for-developers?af=fj2vsx" class="external-link" data-client="eggheadio" data-uid="url">
                <img src="/assets/images/banners/egghead-banner-productive-git.png" style="width:100%" />
            </a>
            

            
            <div class="article-post">
                <div class="article-intro">
    During this journey from <a href="/blog/2021/06/create-nextjs-webapp-nx/">setting up our Next.js app within an Nx workspace</a>, to <a href="/blog/2021/06/setup-tailwind-nextjs-and-nx/">configuring Tailwind</a>, <a href="/blog/2021/06/read-render-markdown-nextjs-and-nx/">Markdown rendering</a>, <a href="/blog/2021/08/nextjs-storybook-tailwind-nx/">Storybook</a> and <a href="/blog/2021/08/nextjs-storybook-cypress-nx/">Cypress</a> we&rsquo;re now at the point where we should look at the deployment of our site. Let&rsquo;s learn how to deploy to some static environment as well as leverage the rich features when deploying to <a href="https://vercel.com/">Vercel</a>.
</div>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9669473064376287" data-ad-slot="2496274486"
    data-ad-format="auto"></ins>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<p><strong>Building a blog with Next.js and Nx Series</strong><br />
This article is part of a series around building a blog with Nx, Next.js, Tailwind, Storybook and Cypress.</p>

<ul>
<li><a href="/blog/2021/06/create-nextjs-webapp-nx">Create a Next.js web app with Nx</a></li>
<li><a href="/blog/2021/06/setup-tailwind-nextjs-and-nx/">Setup Next.js to use Tailwind with Nx</a></li>
<li><a href="/blog/2021/06/read-render-markdown-nextjs-and-nx/">Read and render Markdown files with Next.js and Nx</a></li>
<li><a href="/blog/2021/07/component-hydration-nextjs-nx/">Component hydration with MDX in Next.js and Nx</a></li>
<li><a href="/blog/2021/07/fast-refresh-mdx-files-next-and-nx/">Hot Reload MDX changes in Next.js with Nx</a></li>
<li><a href="/blog/2021/07/nextjs-workspace-generator-blog-draft/">Using Nx Workspace generators to scaffold new blog posts</a></li>
<li><a href="/blog/2021/08/nextjs-storybook-tailwind-nx/">Use Storybook with Next.js, Tailwind and Nx to develop components in isolation</a></li>
<li><a href="/blog/2021/08/nextjs-storybook-cypress-nx/">Use Cypress with Next.js and Nx to battle test your React Components</a></li>
<li><strong>Publishing a Next.js app to Vercel with Nx</strong></li>
</ul>

<p><em>Check back later, <a href="https://twitter.com/juristr">follow me on Twitter</a> or <a href="/newsletter">subscribe to the Newsletter</a> to get updates about upcoming articles</em></p>

<hr />
<div class="article-toc">
    <strong>Table of contents</strong>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#deploying-our-site-as-a-set-of-static-files">Deploying our site as a set of static files</a></li>
<li><a href="#understanding-deployments-on-vercel">Understanding deployments on Vercel</a></li>
<li><a href="#setting-up-our-project-on-vercel">Setting up our project on Vercel</a></li>
<li><a href="#building-your-next-js-app-for-vercel">Building your Next.js app for Vercel</a></li>
<li><a href="#production-deployment-on-vercel">Production deployment on Vercel</a></li>
<li><a href="#preview-deployments-on-vercel">Preview deployments on Vercel</a></li>
<li><a href="#nx-and-computation-caching">Nx and Computation caching</a>
<ul>
<li><a href="#global-implicit-dependencies">Global implicit dependencies</a></li>
<li><a href="#registering-articles-as-a-node-in-the-nx-dependency-graph">Registering _articles as a node in the Nx Dependency Graph</a></li>
</ul></li>
<li><a href="#use-nx-to-build-and-deploy-only-when-something-changed">Use Nx to build and deploy only when something changed</a>
<ul>
<li><a href="#configuring-nx-affected-deploys-on-vercel">Configuring Nx Affected deploys on Vercel</a></li>
<li><a href="#testing-nx-affected-deploys-on-vercel">Testing Nx affected deploys on Vercel</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul></li>
</ul>
</nav>
</div>
<hr />

<h2 id="deploying-our-site-as-a-set-of-static-files">Deploying our site as a set of static files</h2>

<p>In our specific context of developing our personal portfolio website or blog, we can totally rely on static site generators. Tools like <a href="https://jekyllrb.com/">Jekyll</a>, <a href="https://www.11ty.dev/">Eleventy</a>, <a href="https://gohugo.io/">Hugo</a> and so on do a perfect job in taking a set of markdown files and transform them into static HTML files. These can be deployed to any web server that is able to statically serve files. Often these tools are very opinionated on how you should structure your site and where to place the markdown files. This can be a pro and cons, depending on your needs. While for a simple portfolio website you don&rsquo;t really need any kind of backend, as your site grows, you might find it useful to have access to simple cloud functions and persistent backend storage to create a more dynamic experience for your visitors.</p>

<p>Turns out that with Next.js you have many of these properties already built in. As we learned in our <a href="/blog/2021/06/create-nextjs-webapp-nx/">very first article of the series</a>, Next.js allows you to dynamically decide whether to statically or dynamically render it from the server.</p>

<p>In our specific case, we have just used static rendering so far, which <strong>means we can just &ldquo;export&rdquo;</strong> <strong>our site</strong> with this simple command:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">npx nx <span class="nb">export</span> site</code></pre></div>
<p>This generates a set of static HTML, CSS and JS files at <code>dist/apps/site/exported</code>. With a plain simple HTTP server, capable of serving static files, we can run the exported Next.js application.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> dist/apps/site/exported
npx http-server .</code></pre></div>
<p>In many scenarios, such a deployment is all you ever want. You can configure <a href="https://docs.github.com/en/pages/configuring-a-custom-domain-for-your-github-pages-site">GitHub Pages (even with your custom domain)</a> to directly deploy your website from your GitHub repo. Nowadays GitHub has even SSL built-in, and alternatively, you can use <a href="/blog/2017/01/enable-ssl-jekyll-blog/">CloudFlare to enable it</a>.</p>

<h2 id="understanding-deployments-on-vercel">Understanding deployments on Vercel</h2>

<p>If you want to have static deployments, but at the same time the freedom to easily expand beyond that, I&rsquo;d highly recommend having a look at <a href="https://vercel.com">Vercel</a>.</p>

<p>Vercel <a href="https://vercel.com/docs/git">deploys from your Git</a> repository and has different <strong>deployment types</strong>.</p>

<ul>
<li><strong>Production deployment -</strong> Production deployments are made each time you merge to your production branch (e.g. <code>main</code>) or when you use the <code>vercel --prod</code> command. <a href="https://vercel.com/docs/platform/deployments#production">Read more here</a>.</li>
<li><strong>Preview deployment -</strong> This happens every time you push a new commit to a branch or when you run the <code>vercel</code> command. <a href="https://vercel.com/docs/platform/deployments#preview">Read more here</a>.</li>
<li><em>Instant rollbacks</em> are also deployments, which happen whenever you revert any changes to a production deployment</li>
</ul>

<p>Let&rsquo;s get started by configuring our project first.</p>

<h2 id="setting-up-our-project-on-vercel">Setting up our project on Vercel</h2>

<p>To set up our deployments on Vercel, first go to <a href="https://vercel.com/">https://vercel.com/</a>, create an account or log into your existing one. Since we already have our Next.js project setup with Nx, we choose &ldquo;<strong>Create a New Project</strong>&rdquo;.</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-dashboard.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-dashboard.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>We can directly import the repository from GitHub:</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-import-github.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-import-github.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>Once that&rsquo;s done, you&rsquo;ll have to run through the configuration, giving the Vercel platform a couple of inputs on how to build your project. <strong>Creating a team is optional</strong> and really just makes sense if you plan to collaborate with others on the project. Here&rsquo;s what it would look like if we created one.</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-create-team.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-create-team.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>In the next step, you can configure the project, giving it a name to identify it in your Vercel dashboard later. You can leave the other settings untouched.</p>

<p>Before going ahead and hit the <strong>Deploy</strong> we need to configure the &ldquo;Build and Output Settings&rdquo; to use the underlying Nx build commands.</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-configure-project.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-configure-project.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<h2 id="building-your-next-js-app-for-vercel">Building your Next.js app for Vercel</h2>

<p>Similarly to exporting the Next.js app (as we&rsquo;ve seen a couple of sections ago), we can build the Next.js site for Vercel by running the <strong>build</strong> command:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">npx nx build site --prod</code></pre></div>
<p>Once that build succeeds, you can see the output in the <code>dist/apps/site</code> directory.</p>


<figure class="image--medium">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/nextjs-build-outdir.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/nextjs-build-outdir.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<blockquote>
<p><strong>Note:</strong> If needed, you can also customize the output path in the project configuration of your application <code>workspace.json</code></p>
</blockquote>

<p>Let&rsquo;s have a look at how to configure Vercel to pick up these commands.</p>

<h2 id="production-deployment-on-vercel">Production deployment on Vercel</h2>

<p>This would be all Vercel needs to deploy your app successfully. Hence, let&rsquo;s go ahead and configure the &ldquo;Build command&rdquo; and &ldquo;Output directory&rdquo; as shown in the following screenshot:</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-build-settings.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-build-settings.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>Once you hit deploy, Vercel takes over and looks at your <a href="https://vercel.com/docs/git#production-branch">current production branch</a> (in our case <code>main</code>), fetches the source code, executes the build command we have specified above, and deploys it into production.</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-deployment-running.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-deployment-running.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>Congrats, you should now have a successful deployment ðŸŽ‰.</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-successful-first-deployment.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-successful-first-deployment.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>Going to the dashboard we can see more information about the deployment:</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-dashboard-deploy-details.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-dashboard-deploy-details.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>And obviously, we can go to the deployment URL (<a href="https://blog-series-nextjs-nx-alpha.vercel.app/articles/dynamic-routing">https://blog-series-nextjs-nx-alpha.vercel.app/articles/dynamic-routing</a>) and see the site live:</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-deployed-site.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-deployed-site.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<h2 id="preview-deployments-on-vercel">Preview deployments on Vercel</h2>

<p>We just deployed to production. As we described earlier, Vercel has another cool feature that comes in really handy: Preview Deployments.</p>

<p>When you push to a branch that is not the production branch, a preview deployment will be created automatically. Whenever that PR is then merged to the main branch, a production deployment will be triggered.</p>

<p>Let&rsquo;s create a new branch to test these out:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">git checkout -b vercel-preview-deployment-test</code></pre></div>
<p>Let&rsquo;s create a new article in <code>_articles/welcome-to-vercel.mdx</code></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">---
title: <span class="s1">&#39;Welcome to Vercel&#39;</span>
excerpt: <span class="s1">&#39;How to deploy your Nx based Next.js app to Vercel&#39;</span>
date: <span class="s1">&#39;2021-08-25T05:35:07.322Z&#39;</span>
author:
  name: JJ Kasper
---

Hey!! You just deployed your first Nx based Next.js site to Vercel!!</code></pre></div>
<p>If you want to quickly test this locally, run</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">npx nx serve site</code></pre></div>
<p>and navigate to <a href="http://localhost:4200/articles/welcome-to-vercel">http://localhost:4200/articles/welcome-to-vercel</a>. You should see the article be rendered properly. Let&rsquo;s deploy it ðŸš€. Commit your changes and push the branch:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">git push --set-upstream origin vercel-preview-deployment-test</code></pre></div>
<blockquote>
<p><strong>Note:</strong> make sure to use the name of the branch you&rsquo;ve chosen.</p>
</blockquote>

<p>If you go to the <code>/deployments</code> page on your Vercel project, in my case <a href="https://vercel.com/nx-blog-series/blog-series-nextjs-nx/deployments">https://vercel.com/nx-blog-series/blog-series-nextjs-nx/deployments</a>, you should already see a deployment running which is marked as &ldquo;Preview&rdquo;:</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-deployment-overview-running.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-deployment-overview-running.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>In addition, if you create a PR on GitHub, you&rsquo;ll also automatically get the info posted into the PR itself:</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-pr-comment.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-pr-comment.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>There&rsquo;s one thing though. When you make new changes to the <code>_articles/*.mdx</code> files, it might happen that the changes aren&rsquo;t actually being reflected on the deployed preview, even though the deployment ran and finished successfully.</p>

<p>Inspecting the deployment logs, you might see something like &ldquo;<code>[retrieved from cache]</code>&rdquo;.</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/deployment-retrieved-from-cache.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/deployment-retrieved-from-cache.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>This is the Nx <a href="https://nx.dev/latest/react/core-extended/computation-caching">computation caching in action</a>. Let&rsquo;s learn more.</p>

<h2 id="nx-and-computation-caching">Nx and Computation caching</h2>

<p>Nx has an internal computation cache which helps to optimize for speed. Basically, whenever you execute a command which you already ran previously, and granted you didn&rsquo;t change any relevant file that might alter the outcome of that specific task, Nx just replays it from the cache. Sounds complicated? Here&rsquo;s a more detailed video on how this works: <a href="https://egghead.io/lessons/javascript-speed-up-with-nx-computation-caching">https://egghead.io/lessons/javascript-speed-up-with-nx-computation-caching</a></p>

<p>But wait a minute! We did actually change something: we updated one of our files in <code>_articles</code>. Let&rsquo;s dig a bit deeper into how Nx caching works and <strong>how we can influence which files get included in the cache</strong>.</p>

<p>Nx uses <a href="https://egghead.io/lessons/javascript-use-the-nx-dependency-graph-to-visualize-your-monorepo-structure">its internal dependency graph</a> to understand which files to include when it computes the cache. If we look at our dependency graph by running <code>npx nx dep-graph</code> we can see that the <code>_articles</code> folder is not present there.</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/site-deployment-graph-before.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/site-deployment-graph-before.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>As a result, it misses it when calculating the cache, and <strong>hence doesn&rsquo;t invalidate the cache</strong> when we change one of our article MDX files.</p>

<p>Nx is flexible enough to allow us to fix this issue. Here are the options:</p>

<ol>
<li>Adding our <code>_articles</code> files to the global <code>implicitDependencies</code></li>
<li>Moving our articles as a project into the <code>libs/</code> folder and referencing it as an implicit dependency on our <code>site</code> Next.js application</li>
<li>Adding our existing <code>_articles</code> folder as a node to the dependency graph and referencing it as an implicit dependency on our <code>site</code> Next.js application</li>
</ol>

<p>Let&rsquo;s explore them.</p>

<h3 id="global-implicit-dependencies">Global implicit dependencies</h3>

<p>Global implicit dependencies cause the entire Nx workspace to rebuild / retest etc. Basically, on every change of one of these global dependencies, the entire cache gets invalidated and everything gets rebuilt. As you can imagine, this is not always ideal, but there are some use cases where we might want this to happen. Examples are:</p>

<ul>
<li>changes to the CI build configuration when we definitely would want to make sure the CI runs all the projects</li>
<li>changes to our global lint rule configuration file</li>
<li>&hellip;</li>
</ul>

<p>You can specify these global implicit dependencies in the <code>nx.json</code>. Here&rsquo;s an example configuration:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">//</span> <span class="err">nx.json</span>
<span class="p">{</span>
  <span class="nt">&#34;implicitDependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;package.json&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;dependencies&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span><span class="p">,</span>
      <span class="nt">&#34;devDependencies&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span>
    <span class="p">},</span>
    <span class="nt">&#34;.eslintrc.json&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span>
  <span class="p">},</span>
  <span class="err">...</span>
<span class="p">}</span></code></pre></div>
<p>You can read more about it and the possible configuration options <a href="https://nx.dev/latest/react/core-concepts/configuration#implicit-dependencies">on the Nx docs</a>.</p>

<p>For our <code>_articles</code> folder, we could add an entry here that looks like the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">//</span> <span class="err">nx.json</span>
<span class="p">{</span>
  <span class="nt">&#34;implicitDependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="err">...</span>
    <span class="nt">&#34;_articles/*.mdx&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span>
  <span class="p">},</span>
  <span class="err">...</span>
<span class="p">}</span></code></pre></div>
<p>With this configuration, every change to any <code>*.mdx</code> file within the <code>_articles</code> folder would invalidate the Nx cache and cause a full re-computation. This definitely fixes our issue with the Vercel deployments and would totally work for our simple use case. But imagine in a more real-world setting, where you have other apps in this workspace that are not really using the <code>_articles</code> folder at all. Those would also always be recomputed, which is a waste of computation power and ultimately a waste of your time.</p>

<h3 id="registering-articles-as-a-node-in-the-nx-dependency-graph">Registering _articles as a node in the Nx Dependency Graph</h3>

<p>The other options which we had were the following:</p>

<ul>
<li>Moving our articles as a project into the <code>libs/</code> folder and referencing it as an implicit dependency on our <code>site</code> Next.js application</li>
<li>Adding our existing <code>_articles</code> folder as a node to the dependency graph and referencing it as an implicit dependency on our <code>site</code> Next.js application</li>
</ul>

<p>I&rsquo;m skipping the 1st point, as I think it wouldn&rsquo;t be worth the effort of generating a library in the <code>libs</code> folder and removing all of the config files, because clearly, we wouldn&rsquo;t have any use for the TypeScript and Jest configuration. Moreover, I want to have the <code>_articles</code> at the very root where they are easily accessible when I create new ones.</p>

<p>We can however just manually configure our <code>_articles</code> folder s.t. Nx recognizes it as a node in its dependency graph. We can do that by manually adding a configuration in the <code>workspace.json</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">//</span> <span class="err">workspace.json</span>
<span class="p">{</span>
  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="err">...</span>
  <span class="nt">&#34;projects&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="err">...</span>
    <span class="nt">&#34;site-articles&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;root&#34;</span><span class="p">:</span> <span class="s2">&#34;_articles&#34;</span><span class="p">,</span>
      <span class="nt">&#34;sourceRoot&#34;</span><span class="p">:</span> <span class="s2">&#34;_articles&#34;</span><span class="p">,</span>
      <span class="nt">&#34;projectType&#34;</span><span class="p">:</span> <span class="s2">&#34;application&#34;</span><span class="p">,</span>
      <span class="nt">&#34;targets&#34;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>As you can see it is an empty configuration. Also, we use <code>projectType: &quot;application&quot;</code> although it doesn&rsquo;t really matter in this case.</p>

<p>Next, we also need to add a new entry in our <code>nx.json</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">//</span> <span class="err">nx.json</span>
<span class="p">{</span>
  <span class="nt">&#34;implicitDependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="err">...</span>
  <span class="p">},</span>
	<span class="err">...</span>
  <span class="nt">&#34;projects&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="err">...</span>
    <span class="nt">&#34;site-articles&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>If we now run our Nx Dependency graph visualization, using <code>npx nx dep-graph</code>, we should see our &ldquo;site-articles&rdquo; node appear on the graph:</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/site-deployment-graph-with-articles.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/site-deployment-graph-with-articles.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>Finally, we need to make sure to establish a connection from our Next.js app &ldquo;site&rdquo; to &ldquo;site-articles&rdquo;. Nx doesn&rsquo;t recognize this relationship automatically, which it does just for source imports.</p>

<blockquote>
<p>We could extend the Nx dependency graph&rsquo;s capabilities via a custom Nx plugin, but that is the topic of another article series ðŸ˜…. Read more about it here: <a href="https://nx.dev/latest/angular/structure/project-graph-plugins">https://nx.dev/latest/angular/structure/project-graph-plugins</a></p>
</blockquote>

<p>To create this connection, we can add the <code>site-articles</code> node to the <code>implicitDependencies</code> property of <code>site</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">//</span> <span class="err">nx.json</span>
<span class="p">{</span>
  <span class="nt">&#34;implicitDependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
	  <span class="err">...</span>
  <span class="p">},</span>
	<span class="err">...</span>
  <span class="nt">&#34;projects&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="err">...</span>
    <span class="nt">&#34;site&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">[],</span>
      <span class="nt">&#34;implicitDependencies&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;site-articles&#34;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&#34;site-articles&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>Re-running our dependency graph visualization now shows the correct relationship:</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/site-deployment-graph-with-implicit-deps.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/site-deployment-graph-with-implicit-deps.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>Now, every time we change an article, <strong>only our Next.js site</strong> application would be rebuilt, which is exactly what we wanted.</p>

<h2 id="use-nx-to-build-and-deploy-only-when-something-changed">Use Nx to build and deploy only when something changed</h2>

<p>Besides the Nx computation cache we&rsquo;ve just discussed, Nx has another feature that helps you scale. Now again, talking about scaling when creating our personal portfolio and blog site is not really your top priority. The main benefit of going through this blog series though is that you can apply these concepts nearly 1-1 to a real-world project with Nx and Next.js. Even though scaling is not your main concern right now, it definitely might be as your Nx workspace grows and hosts more than just your Next.js application.</p>

<p>The Nx feature I&rsquo;m talking about is so-called &ldquo;affected commands&rdquo;. They only trigger for projects which are affected by the changes we made. Based on the dependency graph of your project and your Git history, Nx is able to figure out on which projects a given command needs to be executed. Without going too much into the details here, feel free to check out these resources for more info:</p>

<ul>
<li>Guide: <a href="https://nx.dev/latest/react/core-extended/affected">Rebuilding and Retesting what is Affected</a></li>
<li>Video: <a href="https://egghead.io/lessons/javascript-scale-ci-runs-with-nx-affected-commands">Scale CI runs with Nx Affected Commands</a></li>
</ul>

<p>To only run our Vercel build if something changed that might have affected it, we can leverage <a href="https://vercel.com/docs/platform/projects#ignored-build-step">Vercel&rsquo;s ignored build step feature</a>. That feature requires us to respond with either an exit code <code>1</code> if the build is required or <code>0</code> if it should be canceled.</p>

<p>This Nx guide describes it in more depth: <a href="https://nx.dev/latest/react/guides/deploy-nextjs-to-vercel#skipping-build-if-the-application-is-not-affected">https://nx.dev/latest/react/guides/deploy-nextjs-to-vercel#skipping-build-if-the-application-is-not-affected</a></p>

<p>To set up affected builds for Vercel, copy the script mentioned in the guide I just linked and place it into the <code>tools/vercel-deploy/vercel-affected-deploy.sh</code> file.</p>

<p>We should also adjust the <code>APP</code> variable to reflect our own app name: <code>site</code>. Most probably we could also inject this via some Vercel environment variable we define for the application. This would make the script more reusable, but I&rsquo;ll leave that for you. So here is the entire script:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># tools/vercel-deploy/vercel-affected-deploy.sh</span>

<span class="c1"># Name of the app to check. Change this to your application name!</span>
<span class="nv">APP</span><span class="o">=</span>site

<span class="c1"># Determine version of Nx installed</span>
<span class="nv">NX_VERSION</span><span class="o">=</span><span class="k">$(</span>node -e <span class="s2">&#34;console.log(require(&#39;./package.json&#39;).devDependencies[&#39;@nrwl/workspace&#39;])&#34;</span><span class="k">)</span>
<span class="nv">TS_VERSION</span><span class="o">=</span><span class="k">$(</span>node -e <span class="s2">&#34;console.log(require(&#39;./package.json&#39;).devDependencies[&#39;typescript&#39;])&#34;</span><span class="k">)</span>

<span class="c1"># Install @nrwl/workspace in order to run the affected command</span>
npm install -D @nrwl/workspace@<span class="nv">$NX_VERSION</span> --prefer-offline
npm install -D typescript@<span class="nv">$TS_VERSION</span> --prefer-offline

<span class="c1"># Run the affected command, comparing latest commit to the one before that</span>
npx nx affected:apps --plain --base HEAD~1 --head HEAD <span class="p">|</span> grep <span class="nv">$APP</span> -q

<span class="c1"># Store result of the previous command (grep)</span>
<span class="nv">IS_AFFECTED</span><span class="o">=</span><span class="nv">$?</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$IS_AFFECTED</span> -eq <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&#34;ðŸ›‘ - Build cancelled&#34;</span>
  <span class="nb">exit</span> <span class="m">0</span>
<span class="k">elif</span> <span class="o">[</span> <span class="nv">$IS_AFFECTED</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&#34;âœ… - Build can proceed&#34;</span>
  <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span></code></pre></div>
<p>Note that there&rsquo;s the line where we print out all the affected apps (because we need to deploy those) and filter it for the provided application name:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">npx nx affected:apps --plain --base HEAD~1 --head HEAD <span class="p">|</span> grep <span class="nv">$APP</span> -q</code></pre></div>
<p>By default, Nx compares the current Git HEAD with the main production branch. Make sure you set it to the one you&rsquo;re using in the <code>nx.json</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">//</span> <span class="err">nx.json</span>
<span class="p">{</span>
  <span class="nt">&#34;implicitDependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
     <span class="err">...</span>
  <span class="p">},</span>
  <span class="nt">&#34;affected&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;defaultBase&#34;</span><span class="p">:</span> <span class="s2">&#34;main&#34;</span>
  <span class="p">},</span>
  <span class="err">...</span>
  <span class="nt">&#34;projects&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="err">...</span>
  <span class="p">},</span>
  <span class="err">...</span>
<span class="p">}</span></code></pre></div>
<p>Make sure it matches your main branch name. In my case it is <code>main</code>.</p>

<p>The script above explicitly passes the base and head references explicitly, setting them to <code>HEAD~1</code> and <code>HEAD</code> accordingly. Basically just comparing the changes that have been made from the last commit.</p>

<blockquote>
<p><strong>Note,</strong> right now it is not possible to get a reference to the last successful deployment commit SHA on Vercel. If that was possible we could pass that to <code>--base</code> and thus have an even more efficient affected command evaluation because it would allow us to truly determine what changed since the last deployment.</p>
</blockquote>

<h3 id="configuring-nx-affected-deploys-on-vercel">Configuring Nx Affected deploys on Vercel</h3>

<p>Finally, <strong>let&rsquo;s configure the script on Vercel</strong>. Go to the <code>Settings &gt; Git</code> and scroll to the section &ldquo;Ignored Build Step&rdquo;. Add <code>./tools/vercel-deploy/vercel-affected-deploy.sh</code> and save your configuration.</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-ignore-build-step.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-ignore-build-step.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<h3 id="testing-nx-affected-deploys-on-vercel">Testing Nx affected deploys on Vercel</h3>

<p>To verify whether our script works, let&rsquo;s create a new  React application in our workspace. For the sake of this simple showcase, let&rsquo;s call it &ldquo;react-demo&rdquo;.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">npx nx g @nrwl/react:app</code></pre></div>
<p>Also, let&rsquo;s create a new React library <code>react-ui</code> :</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">npx</span> <span class="err">nx</span> <span class="err">g</span> <span class="err">@nrwl/react:lib</span> <span class="err">reactui</span></code></pre></div>
<p>Finally, let&rsquo;s change the generated React application in a way to create dependencies to <code>react-ui</code> as well as <code>shared-ui</code>. To do so, open <code>apps/react-app/src/app/app.tsx</code> and replace its content with the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-tsx" data-lang="tsx"><span class="kr">import</span> <span class="nx">styles</span> <span class="nx">from</span> <span class="s1">&#39;./app.module.css&#39;</span><span class="p">;</span>

<span class="kr">import</span> <span class="p">{</span> <span class="nx">ReactComponent</span> <span class="kr">as</span> <span class="nx">Logo</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;./logo.svg&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">TopicButton</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;@juridev/shared/ui&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Reactui</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;@juridev/reactui&#39;</span><span class="p">;</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">App() {</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">app</span><span class="p">}</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">header</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&#34;flex&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">Logo</span> <span class="nx">width</span><span class="o">=</span><span class="s2">&#34;75&#34;</span> <span class="nx">height</span><span class="o">=</span><span class="s2">&#34;75&#34;</span> <span class="err">/&gt;</span>
        <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Welcome</span> <span class="nx">to</span> <span class="nx">react</span><span class="o">-</span><span class="nx">app</span><span class="o">!&lt;</span><span class="err">/h1&gt;</span>
      <span class="o">&lt;</span><span class="err">/header&gt;</span>
      <span class="o">&lt;</span><span class="nx">main</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">TopicButton</span> <span class="nx">topicName</span><span class="o">=</span><span class="s2">&#34;React&#34;</span> <span class="err">/&gt;</span>
        <span class="o">&lt;</span><span class="nx">Reactui</span> <span class="err">/&gt;</span>
      <span class="o">&lt;</span><span class="err">/main&gt;</span>
    <span class="o">&lt;</span><span class="err">/div&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">App</span><span class="p">;</span></code></pre></div>
<p>If you now visualize the dependency graph with <code>nx dep-graph</code> you should see something like the following:</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/site-dep-graph-with-reactapp.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/site-dep-graph-with-reactapp.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>Commit everything and push it to your GitHub repo.</p>

<p>When the build is triggered on Vercel, you should now see that the <code>vercel-affected-deploy.sh</code> has been used.</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-deployment-cancelled.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-deployment-cancelled.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>Since we didn&rsquo;t change anything related to our Next.js application, the build gets canceled just as we expect.</p>

<p>Let&rsquo;s try to change something in the <code>react-ui</code> library which is supposed to be our React application specific UI library.</p>
<div class="highlight"><pre class="chroma"><code class="language-tsx" data-lang="tsx"><span class="c1">// libs/reactui/src/lib/reactui.tsx
</span><span class="c1"></span><span class="kr">import</span> <span class="s1">&#39;./reactui.module.css&#39;</span><span class="p">;</span>

<span class="cm">/* eslint-disable-next-line */</span>
<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ReactuiProps</span> <span class="p">{}</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">Reactui</span><span class="p">(</span><span class="nx">props</span>: <span class="kt">ReactuiProps</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Welcome</span> <span class="nx">to</span> <span class="nx">Reactui</span><span class="o">!&lt;</span><span class="err">/h1&gt;</span>
      <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Nx</span> <span class="err">â¤ï¸</span> <span class="nx">Next</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
    <span class="o">&lt;</span><span class="err">/div&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Reactui</span><span class="p">;</span></code></pre></div>
<p><strong>Commit the change</strong>, then execute the command Vercel will execute to determine whether to deploy our &ldquo;site&rdquo; app or not. Instead of <code>affected:apps</code> we can also use <code>affected:dep-graph</code> to show what changed in our last commit:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">npx nx affected:dep-graph --base HEAD~1 --head HEAD</code></pre></div>

<figure class="image--small">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-affected-deploy-graph.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-affected-deploy-graph.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>If you push this commit to your GitHub repo, Vercel would again cancel the deployment as expected.</p>

<p>If however, we make a change in our <code>shared-ui</code> library, which our React application as well as our Next.js based <code>site</code> application depends on, then a deployment would be triggered.</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/vercel-affected-deploy-full.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/vercel-affected-deploy-full.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<h2 id="conclusion">Conclusion</h2>

<p>This article was quite packed with knowledge. We learned</p>

<ul>
<li>How to export our Next.js based site as a set of static assets</li>
<li>What type of deployments Vercel offers</li>
<li>How to configure our project on Vercel</li>
<li>How to build our Next.js based Nx application for Vercel</li>
<li>How to configure our Nx project on Vercel</li>
<li>What Nx computation cache is all about and how to configure implicit dependencies</li>
<li>How Nx affected commands work and how we can configure them on Vercel</li>
</ul>

<p>See also:</p>

<ul>
<li><a href="https://nx.dev/latest/react/guides/deploy-nextjs-to-vercel">https://nx.dev/latest/react/guides/deploy-nextjs-to-vercel</a></li>
<li><a href="https://nextjs.org/docs/deployment">https://nextjs.org/docs/deployment</a></li>
<li><a href="https://vercel.com/docs/git">https://vercel.com/docs/git</a></li>
<li><a href="https://nextjs.org/learn/basics/deploying-nextjs-app">https://nextjs.org/learn/basics/deploying-nextjs-app</a></li>
<li><a href="https://egghead.io/lessons/javascript-speed-up-with-nx-computation-caching">https://egghead.io/lessons/javascript-speed-up-with-nx-computation-caching</a></li>
<li><a href="https://nx.dev/latest/react/core-extended/affected">https://nx.dev/latest/react/core-extended/affected</a></li>
<li><a href="https://egghead.io/lessons/javascript-scale-ci-runs-with-nx-affected-commands">https://egghead.io/lessons/javascript-scale-ci-runs-with-nx-affected-commands</a></li>
</ul>

<p><strong>GitHub repository</strong></p>

<p>All the sources for this article can be found in this GitHub repository&rsquo;s branch: <a href="https://github.com/juristr/blog-series-nextjs-nx/tree/09-deploy-to-vercel">https://github.com/juristr/blog-series-nextjs-nx/tree/09-deploy-to-vercel</a></p>

				<hr />

				Questions? Thoughts? Hit me up <a href="https://twitter.com/juristr" target="_blank">on Twitter</a>
            </div>

            
            <div class="after-post-tags">
                <ul class="tags">
                    
                    <li>
                        <a href="/tags/Next">Next</a>
                    </li>
                    
                    <li>
                        <a href="/tags/TailwindCSS">TailwindCSS</a>
                    </li>
                    
                    <li>
                        <a href="/tags/React">React</a>
                    </li>
                    
                    <li>
                        <a href="/tags/Storybook">Storybook</a>
                    </li>
                    
                    <li>
                        <a href="/tags/Vercel">Vercel</a>
                    </li>
                    
                </ul>
            </div>
            

            <a href="https://egghead.io/instructors/juri-strumpflohner" class="external-link" data-client="eggheadio"
                data-uid="egghead-instructor-page">
                <img src="/blog/assets/imgs/egghead-banner-learn-with-me.png" style="width:100%" />
            </a>

            
            
            
        </div>
        
    </div>
</div>

<div class="hideshare"></div>



<div class="related-container">
    <div class="container">
        <div class="row listrecent listrelated">
            
            

            <div class="col-md-4">
<div class="card">
    
    <div class="card-block">
        <h2 class="card-title">
            <a href="/blog/2021/08/nextjs-storybook-cypress-nx">Use Cypress with Next.js and Nx to battle test your React Components</a>
        </h2>
        <h4 class="card-text">
            Learn how to use Next.js, Nx and Tailwind together
            
        </h4>
        <div class="metafooter">
            <div class="wrapfooter">
                <div class="row">
                    <div class="col-10">
                        
                            <span class="meta-footer-thumb">
                                <a href="/about/">
                                    <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                                </a>
                            </span>
                            <span class="author-meta">
                                <span class="post-name"><a href="/about/">Juri Strumpflohner</a></span><br />
                                <span class="post-date">Aug 18, 2021</span><span class="dot"></span><span
                                    class="post-read">7 min read</span>
                            </span>
                        
                    </div>
                    <div class="col-2">
                        
                        
                        
                        <span class="post-category-icon">
                            
                            
                                <img src="/assets/images/categories/next.svg" />
                            
                        </span>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    
</div>

            </div>

            

            <div class="col-md-4">
<div class="card">
    
    <div class="card-block">
        <h2 class="card-title">
            <a href="/blog/2021/08/nextjs-storybook-tailwind-nx">Use Storybook with Tailwind in an Nx Workspace</a>
        </h2>
        <h4 class="card-text">
            Learn how to use Next.js, Nx and Tailwind together
            
        </h4>
        <div class="metafooter">
            <div class="wrapfooter">
                <div class="row">
                    <div class="col-10">
                        
                            <span class="meta-footer-thumb">
                                <a href="/about/">
                                    <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                                </a>
                            </span>
                            <span class="author-meta">
                                <span class="post-name"><a href="/about/">Juri Strumpflohner</a></span><br />
                                <span class="post-date">Aug 12, 2021</span><span class="dot"></span><span
                                    class="post-read">10 min read</span>
                            </span>
                        
                    </div>
                    <div class="col-2">
                        
                        
                        
                        <span class="post-category-icon">
                            
                            
                                <img src="/assets/images/categories/next.svg" />
                            
                        </span>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    
</div>

            </div>

            

            <div class="col-md-4">
<div class="card">
    
    <div class="card-block">
        <h2 class="card-title">
            <a href="/blog/2021/07/nextjs-workspace-generator-blog-draft/">Using Nx Workspace generators to scaffold new blog posts</a>
        </h2>
        <h4 class="card-text">
            Learn how to use Next.js, Nx and Tailwind together
            
        </h4>
        <div class="metafooter">
            <div class="wrapfooter">
                <div class="row">
                    <div class="col-10">
                        
                            <span class="meta-footer-thumb">
                                <a href="/about/">
                                    <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                                </a>
                            </span>
                            <span class="author-meta">
                                <span class="post-name"><a href="/about/">Juri Strumpflohner</a></span><br />
                                <span class="post-date">Jul 28, 2021</span><span class="dot"></span><span
                                    class="post-read">11 min read</span>
                            </span>
                        
                    </div>
                    <div class="col-2">
                        
                        
                        
                        <span class="post-category-icon">
                            
                            
                                <img src="/assets/images/categories/next.svg" />
                            
                        </span>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    
</div>

            </div>

            
            

        </div>
    </div>
</div>

<div class="container">
    <div id="comments" class="row justify-content-center mb-5">
        <div class="col-md-8">              
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "juristr" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>               
        </div>
    </div>
</div>



<script type="text/javascript" src="//downloads.mailchimp.com/js/signup-forms/popup/unique-methods/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script><script type="text/javascript">window.dojoRequire(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us4.list-manage.com","uuid":"04e83acc0ba14b18f30435204","lid":"1d83b68321","uniqueMethods":true}) })</script>
<div class="container">
    
<div class="footer">
    <p class="pull-left">
        &copy; Copyright Juri Strumpflohner - All rights reserved
    </p>
    <p class="pull-right">
        Customized Mediumish Theme, originally by <a target="_blank" href="https://www.wowthemes.net">WowThemes.net</a>
    </p>
    <div class="clearfix">
    </div>
</div>


</div>

    </div>

<script src="/js/jquery.min.js"></script>


<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-throttle-debounce/1.1/jquery.ba-throttle-debounce.min.js"></script>




<script type="text/javascript" src="/js/bundle.js" integrity=""></script>


<script src="/js/jquery.fluidbox.min.js"></script>
<script>
    $('a.image--zoom,.gallery>a').fluidbox();
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-416229-12', 'juristr.com');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
  </script>






    
    <script type="text/javascript">
        window.cookieconsent_options = {
            "message": "This website uses cookies to ensure you get the best experience on our website",
            "dismiss": "Got it!",
            "learnMore": "More info",
            "link": null,
            "theme": "dark-bottom"
        };
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js" defer></script>
    

    
    
    
    <script>
!function(t,e,a,c,x){var s='q';t[s]={publication_id:c,tags:x};
var s=e.createElement(a),r=e.getElementsByTagName(a)[0];s.async=1,s.src=
'https://insights.quiet.ly/app/analytics.min.js',r.parentNode.insertBefore(s,r)}
(window,document,'script','87bcee90-0c51-4a68-a60b-e95df730d1ca','[]');
</script>
    
 <script>
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }
  </script>
</body>

</html>
