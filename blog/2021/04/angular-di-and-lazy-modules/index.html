<!DOCTYPE html>
<html lang="en-us"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="generator" content="Hugo 0.53" />
	
	<link rel="shortcut icon" href="/assets/images/sitelogo.jpeg">
	
	<title>Angular Services, providedIn and Lazy Modules | juri.dev</title>
	
	<meta name="description" content="Let&#39;s explore some of the particularities of the Angular dependency injection mechanism">
	
	
	<meta name="robots" content="index, follow">

	
	<meta name="author" content="Juri Strumpflohner">
	<link rel="me" href="https://profiles.google.com/104904743888756261987" />
	<link rel="publisher" href='https://plus.google.com/104904743888756261987' />
	<meta property="twitter:account_id" content="14407063" />


	
	<meta name="google-site-verification" content="0_vyoIaeMG1kXR0h-48gy3OaGl8xoiSJsFDxxCTIBMs" />
	<meta name="google-site-verification" content="AvmssSjl_nchNXIqBW8Agb_UjGqvvLP7HXSxBZ9d0cg" />

	
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@juristr" />
	<meta name="twitter:creator" content="@juristr" />
	<meta name="twitter:title" content="Angular Services, providedIn and Lazy Modules" />
	
	<meta name="twitter:description" content="Let&#39;s explore some of the particularities of the Angular dependency injection mechanism" />
	

	
	<meta name="twitter:image:src" content="https://juristr.com/blog/assets/imgs/di-lazy-modules.png" />
	

	
	<meta property="og:type" content="article" />
	<meta property="og:title" content="Angular Services, providedIn and Lazy Modules" />
	
	<meta property="og:description" content="Let&#39;s explore some of the particularities of the Angular dependency injection mechanism" />
	
	
	<meta property="og:image" content="https://juristr.com/blog/assets/imgs/di-lazy-modules.png" />
	
	<meta property="og:url" content="https://juristr.com/blog/2021/04/angular-di-and-lazy-modules" />
	<meta property="og:site_name" content="juristr.com" />

	

	
	<link rel="alternate" type="application/rss+xml" title="Juri Strumpflohner" href="//feeds.feedburner.com/juristrumpflohner">
	

	
	<link href="/css/bootstrap.min.css" rel="stylesheet">

	
	
	<link href='//fonts.googleapis.com/css?family=Righteous|Roboto:400,700,900|Source+Code+Pro|Lora:400,700,400italic|Material+Icons'
	 rel='stylesheet' type='text/css'>
	

	

	
	
	
	<link rel="stylesheet" href="/scss/main.min.css" integrity="" media="screen">

	

	

	
	
	<link rel="stylesheet" href="/scss/article.min.css" integrity="" media="screen">
	

	
	
	<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
<header class="navbar-light bg-white fixed-top mediumnavigation nav-down">
    <div class="container">

        
        <div class="row justify-content-center align-items-center brandrow">

            <div class="col-lg-4 col-md-4 col-xs-12 d-none d-md-block hidden-xs customarea">
                <img src="/assets/images/gde.svg" style="height:23px">
                <a href="https://developers.google.com/community/experts/directory/profile/profile-juri_strumpflohner" style="
                    padding-left: 5px;
                    font-size: 15pt;
                ">GDE
                    for Web Tech</a>
                

            </div>

            <div class="col-lg-4 col-md-4  col-xs-12 text-center logoarea">
                <a class="navbar-brand" href="https://juristr.com/">
                    
                    <span style="font-family:Righteous;">juri.dev</span>
                    
                </a>
                
            </div>

            <div class="col-lg-4 col-md-4  col-xs-12 text-right d-none d-md-block">
                <a href="https://twitter.com/juristr" class="twitter-follow-button" data-show-count="true">Follow me!</a>
                <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            </div>

        </div>
        

        <div class="navarea">

            <nav class="navbar navbar-toggleable-sm">
                
                <div id="bs4navbar" class="navbar-collapse">
                    
                    <ul id="menu-top-menu" class="navbar-nav col-md-12 justify-content-center">
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/">Home</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/blog">Blog</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/categories">Collections</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/newsletter">Newsletter</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="https://github.com/juristr/ama">AMA</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/about">About Me</a>
                        </li>
                        
                    </ul>

                    
                </div>
            </nav>

        </div>

    </div>

</header>

    <div class="site-content">



<div class="container page-container">
    <div class="row">
        
        <div class="col-md-2 pl-0"><div class="share">
    <p>
        Share
    </p>
    <ul>
        <li>
            <a target="_blank" href="https://twitter.com/home?status=Check out this post by @juristr https%3a%2f%2fjuristr.com%2fblog%2f2021%2f04%2fangular-di-and-lazy-modules%2f">
                <svg class="svgIcon-use" width="29" height="29" viewbox="0 0 29 29">
                    <path d="M21.967 11.8c.018 5.93-4.607 11.18-11.177 11.18-2.172 0-4.25-.62-6.047-1.76l-.268.422-.038.5.186.013.168.012c.3.02.44.032.6.046 2.06-.026 3.95-.686 5.49-1.86l1.12-.85-1.4-.048c-1.57-.055-2.92-1.08-3.36-2.51l-.48.146-.05.5c.22.03.48.05.75.08.48-.02.87-.07 1.25-.15l2.33-.49-2.32-.49c-1.68-.35-2.91-1.83-2.91-3.55 0-.05 0-.01-.01.03l-.49-.1-.25.44c.63.36 1.35.57 2.07.58l1.7.04L7.4 13c-.978-.662-1.59-1.79-1.618-3.047a4.08 4.08 0 0 1 .524-1.8l-.825.07a12.188 12.188 0 0 0 8.81 4.515l.59.033-.06-.59v-.02c-.05-.43-.06-.63-.06-.87a3.617 3.617 0 0 1 6.27-2.45l.2.21.28-.06c1.01-.22 1.94-.59 2.73-1.09l-.75-.56c-.1.36-.04.89.12 1.36.23.68.58 1.13 1.17.85l-.21-.45-.42-.27c-.52.8-1.17 1.48-1.92 2L22 11l.016.28c.013.2.014.35 0 .52v.04zm.998.038c.018-.22.017-.417 0-.66l-.498.034.284.41a8.183 8.183 0 0 0 2.2-2.267l.97-1.48-1.6.755c.17-.08.3-.02.34.03a.914.914 0 0 1-.13-.292c-.1-.297-.13-.64-.1-.766l.36-1.254-1.1.695c-.69.438-1.51.764-2.41.963l.48.15a4.574 4.574 0 0 0-3.38-1.484 4.616 4.616 0 0 0-4.61 4.613c0 .29.02.51.08.984l.01.02.5-.06.03-.5c-3.17-.18-6.1-1.7-8.08-4.15l-.48-.56-.36.64c-.39.69-.62 1.48-.65 2.28.04 1.61.81 3.04 2.06 3.88l.3-.92c-.55-.02-1.11-.17-1.6-.45l-.59-.34-.14.67c-.02.08-.02.16 0 .24-.01 2.12 1.55 4.01 3.69 4.46l.1-.49-.1-.49c-.33.07-.67.12-1.03.14-.18-.02-.43-.05-.64-.07l-.76-.09.23.73c.57 1.84 2.29 3.14 4.28 3.21l-.28-.89a8.252 8.252 0 0 1-4.85 1.66c-.12-.01-.26-.02-.56-.05l-.17-.01-.18-.01L2.53 21l1.694 1.07a12.233 12.233 0 0 0 6.58 1.917c7.156 0 12.2-5.73 12.18-12.18l-.002.04z"></path>
                </svg>
            </a>
        </li>
        <li>
            <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjuristr.com%2fblog%2f2021%2f04%2fangular-di-and-lazy-modules%2f">
                <svg class="svgIcon-use" width="29" height="29" viewbox="0 0 29 29">
                    <path d="M16.39 23.61v-5.808h1.846a.55.55 0 0 0 .546-.48l.36-2.797a.551.551 0 0 0-.547-.62H16.39V12.67c0-.67.12-.813.828-.813h1.474a.55.55 0 0 0 .55-.55V8.803a.55.55 0 0 0-.477-.545c-.436-.06-1.36-.116-2.22-.116-2.5 0-4.13 1.62-4.13 4.248v1.513H10.56a.551.551 0 0 0-.55.55v2.797c0 .304.248.55.55.55h1.855v5.76c-4.172-.96-7.215-4.7-7.215-9.1 0-5.17 4.17-9.36 9.31-9.36 5.14 0 9.31 4.19 9.31 9.36 0 4.48-3.155 8.27-7.43 9.15M14.51 4C8.76 4 4.1 8.684 4.1 14.46c0 5.162 3.75 9.523 8.778 10.32a.55.55 0 0 0 .637-.543v-6.985a.551.551 0 0 0-.55-.55H11.11v-1.697h1.855a.55.55 0 0 0 .55-.55v-2.063c0-2.02 1.136-3.148 3.03-3.148.567 0 1.156.027 1.597.06v1.453h-.924c-1.363 0-1.93.675-1.93 1.912v1.78c0 .3.247.55.55.55h2.132l-.218 1.69H15.84c-.305 0-.55.24-.55.55v7.02c0 .33.293.59.623.54 5.135-.7 9.007-5.11 9.007-10.36C24.92 8.68 20.26 4 14.51 4"></path>
                </svg>
            </a>
        </li>
    </ul>
    
</div></div>
        
        <div class="col-md-9 col-md-offset-2 col-xs-12">
            <div class="mainheading">

                
                
                
                
                <div class="row post-top-meta">
                    
                    <div class="col-md-2">
                        <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                    </div>
                    <div class="col-md-10">
                        <a class="link-dark" href="/about/">Juri Strumpflohner</a><a href="https://twitter.com/@juristr"
                            class="btn follow">Follow</a>
                        <span class="author-description">Juri is a full stack developer and tech lead with a special passion for the web and frontend development. He creates online videos for <a href="https://egghead.io/instructors/juri-strumpflohner">Egghead.io</a>, writes articles on his blog and for tech magazines, speaks at conferences and holds training workshops. Juri is also a recognized Google Developer Expert in Web Technologies</span>
                        
                    </div>
                    
                </div>
                
                
                
                

                <h1 class="posttitle">Angular Services, providedIn and Lazy Modules</h1>
                
                <h2 class="article-subtitle">Let&#39;s explore some of the particularities of the Angular dependency injection mechanism</h2>
                
                <p>
                    <span class="post-date">
                        <time class="post-date">
                            Apr 20, 2021
                        </time></span>
                    <span class="dot"></span>
                    <span class="post-read">9 min read</span>
                </p>
            </div>

            
            
            

            
            <a href="https://egghead.io/courses/productive-git-for-developers?af=fj2vsx" class="external-link" data-client="eggheadio" data-uid="url">
                <img src="/assets/images/banners/egghead-banner-productive-git.png" style="width:100%" />
            </a>
            

            
            <div class="article-post">
                <div class="article-intro">
    I often see people confused about how the DI works, in particular with lazy loaded modules. In this article we’re going to explore some dependency injection particularities with Angular, specifically in combination with lazy loaded modules.
</div>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9669473064376287" data-ad-slot="2496274486"
    data-ad-format="auto"></ins>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<hr />
<div class="article-toc">
    <strong>Table of contents</strong>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#registering-the-service-on-the-providers-array">Registering the service on the providers array</a>
<ul>
<li><a href="#no-provider-for-dataservice-error">No Provider for DataService error</a></li>
<li><a href="#don-t-register-the-service-on-other-ngmodules">❌ Don’t register the service on other NgModules</a></li>
<li><a href="#runtime-situation">Runtime situation</a></li>
<li><a href="#bundling-situation">Bundling situation</a></li>
</ul></li>
<li><a href="#using-the-providedin-syntax">Using the providedIn syntax</a>
<ul>
<li><a href="#runtime-situation-1">Runtime situation</a></li>
<li><a href="#bundling-situation-1">Bundling situation</a></li>
</ul></li>
<li><a href="#thoughts-about-ngrx">Thoughts about NgRx</a></li>
<li><a href="#conclusion">Conclusion</a>
<ul>
<li><a href="#useful-references">Useful References</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
</div>
<hr />

<p>Angular always had a dependency injection support, from Angular.js v1.x to the new, rewritten Angular 2+. There are a couple ways of registering services in Angular, which might have an impact on the lifecycle of the service itself as well as to tree shaking and bundle size. Let’s dive in.</p>

<blockquote>
<p>Wanna try it out by yourself. Here&rsquo;s an example repository: <a href="https://github.com/juristr/angular-services-di-lazyloading">https://github.com/juristr/angular-services-di-lazyloading</a></p>
</blockquote>

<p>Let’s assume we have the following example application.</p>

<pre><code>src
 |___ data-access
      |__ data.service.ts
      |__ ...
      |__ data-access.module.ts
 |___ feature1
      |__ ...
      |__ feature1.module.ts
 |___ feature2
      |__ ...
      |__ feature2.module.ts
</code></pre>

<h2 id="registering-the-service-on-the-providers-array">Registering the service on the providers array</h2>

<p>The classic/standard approach of registering services (especially pre-Angular v8) is to register it on the <code>NgModule.providers</code> array.</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">DataService</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;./data.service&#39;</span>
<span class="p">...</span>
<span class="kd">@NgModule</span><span class="p">({</span>
   <span class="p">...</span>
   <span class="nx">providers</span><span class="o">:</span> <span class="p">[</span> <span class="nx">DataService</span> <span class="p">]</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">DataAccessModule</span> <span class="p">{</span> <span class="p">}</span></code></pre></div>
<h3 id="no-provider-for-dataservice-error">No Provider for DataService error</h3>

<p>Assume you need the <code>DataService</code> inside a component that is part of <code>Feature1Module</code>. Naively you would simply add it to the constructor and expect the dependency injector to properly provide it:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">DataService</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../data-access/data.service&#39;</span><span class="p">;</span>
<span class="p">...</span>
<span class="kd">@Component</span><span class="p">({</span>
   <span class="nx">selector</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
   <span class="p">...</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">Feature1Component</span> <span class="p">{</span>
   <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">dataService</span>: <span class="kt">DataService</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span></code></pre></div>
<p>However, you might get this error:</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/no-provider-error.png" class="image--zoom">
            <img src="/blog/assets/imgs/no-provider-error.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>This happens because we registered the <code>DataService</code> on the <code>DataAccessModule.provider</code> array. Since we also didn’t import the <code>DataAccessModule</code> into the <code>Feature1Module.imports</code> array, <code>Feature1Module</code> does not know about the existence of the <code>DataService</code>.</p>

<blockquote>
<p>Note: this error might not be bad at all. Assume that service is accessing some underlying NgrxStore, which in turn registers its effects and reducers on the <code>DataAccessModule</code>. You&rsquo;d definitely want <code>Feature1Module</code> to import <code>DataAccessModule</code> to get all that Ngrx infrastructure registered and set up.</p>
</blockquote>

<h3 id="don-t-register-the-service-on-other-ngmodules">❌ Don’t register the service on other NgModules</h3>

<p>Now obviously what you could do to circumvent the before mentioned error, is to register the <code>DataService</code> directly on the <code>Feature1Module.providers</code> array.</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// don&#39;t import services from other modules and register them here
</span><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">DataService</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../data-access/data.service&#39;</span><span class="p">;</span>
<span class="p">...</span>
<span class="kd">@NgModule</span><span class="p">({</span>
  <span class="p">...</span>
  <span class="nx">providers</span><span class="o">:</span> <span class="p">[</span><span class="nx">DataService</span><span class="p">]</span> <span class="c1">// &lt;&lt;&lt;
</span><span class="c1"></span><span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">Feature1Module</span> <span class="p">{}</span></code></pre></div>
<p>This should <strong>absolutely be avoided!</strong> Angular modules have most often a 1-1 correspondence with some file system folder. The Angular service should thus be registered on the <code>NgModule</code> that is located closest to where the service file is. In our case, you’d register the <code>DataService</code> on the <code>DataAccessModule.provider</code> located in the <code>src/data-access/data-access.module.ts</code>.</p>

<h3 id="runtime-situation">Runtime situation</h3>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="//www.youtube.com/embed/OPKMq1vXZi0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


<p>When you search for Angular injectors you&rsquo;ll most probably came across the hierarchical nature of injectors in Angular. There&rsquo;s basically a NgModule injector (<code>ModuleInjector</code>) and an element level injector (<code>ElementInjector</code>) scoped to DOM elements and used by Directives or Components. You can read more on the <a href="https://angular.io/guide/hierarchical-dependency-injection">official docs here</a>.</p>

<p>Those things are important and useful for scoping Angular services in their visibility and lifetime. In our specific example there&rsquo;s another mechanism that kicks in though.</p>

<p><strong>Angular services are globally available on the dependency injector by default</strong> or to be more specific, for <strong>eagerly loaded modules</strong>. What do I mean?</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/di-eager-modules.png" class="image--zoom">
            <img src="/blog/assets/imgs/di-eager-modules.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>Reusing our previous example, once <code>Feature1Module</code> imports <code>DataAccessModule</code>, the <code>DataService</code> is registered on the root injector and globally available. Meaning if <code>Feature2Module</code> requires <code>DataService</code> it’ll work without exception, even though <code>Feature2Module</code> did not import <code>DataAccessModule</code> (where <code>DataService</code> is registered). I do not recommend relying on that though!</p>

<p>You should not rely on that because once you decide to lazy load modules you might run into trouble.</p>

<blockquote>
<p>When the Angular router lazy-loads a module, it <strong>creates a new injector</strong>. This injector is a child of the root application injector. Imagine a tree of injectors; there is a single root injector and then <strong>a child injector for each lazy loaded module</strong>. The router adds all of the providers from the root injector to the child injector. When the router creates a component within the lazy-loaded context, Angular prefers service instances created from these providers to the service instances of the application root injector.</p>
</blockquote>

<p><em>Source: <a href="https://angular.io/guide/providers#limiting-provider-scope-by-lazy-loading-modules">https://angular.io/guide/providers#limiting-provider-scope-by-lazy-loading-modules</a></em></p>

<p>Basically the situation looks as follows:</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/di-lazy-modules.png" class="image--zoom">
            <img src="/blog/assets/imgs/di-lazy-modules.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<p>As mentioned, you should import the <code>DataAccessModule</code> wherever you need access to the <code>DataService</code>. In our example that would mean to import it into the <code>Feature1Module</code> and <code>Feature2Module</code>.</p>

<p>So far so good, but what happens if we decide to <strong>lazy load both of the feature modules</strong>?</p>

<p>Since both of them import the <code>DataAccessModule</code> the <code>DataService</code> on the <code>providers</code> array gets registered to the created child injector for each of the two lazy loaded feature modules. Hence <strong>we end up with 2 instances at runtime</strong>. This might not be a problem but definitely should be considered, especially if the services are stateful.</p>

<h3 id="bundling-situation">Bundling situation</h3>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="//www.youtube.com/embed/cLTMCaiquxc" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


<p>What does that mean at <strong>build time?</strong> Since the <code>commonChunk</code> is enabled by default, we&rsquo;d get the following bundles if we lazy load both feature modules:</p>

<ul>
<li><code>feature1-feature1-module.js</code> - contains all feature1 related code</li>
<li><code>feature2-feature2-module.js</code> - contains all feature2 related code</li>
<li><code>common.js</code> - contains shared code among the two, e.g. our <code>DataAccessModule</code> and <code>DataService</code></li>
</ul>

<h2 id="using-the-providedin-syntax">Using the providedIn syntax</h2>

<p>Angular v8 introduced the <code>providedIn</code> syntax. Let’s see how that changes the situation. The <code>providedIn</code> option on the <code>Injectable()</code> can be used with <code>root</code> or by providing the according <code>NgModule</code>.</p>

<p><strong>Example 1: registering a service on the root injector</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">@Injectable</span><span class="p">({</span>
  <span class="nx">providedIn</span><span class="o">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">DataService</span> <span class="p">{...}</span></code></pre></div>
<p><strong>Example 2: registering a service on module injector</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kd">@Injectable</span><span class="p">({</span>
  <span class="nx">providedIn</span>: <span class="kt">DataAccessModule</span><span class="p">,</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">DataService</span> <span class="p">{...}</span></code></pre></div>
<h3 id="runtime-situation-1">Runtime situation</h3>

<p>Using a setup as shown in example 2 leads to two services being live at runtime, one for each lazy loaded feature. This is similar to using the <code>providers</code> array, but with the benefit of being able to leverage tree-shaking and thus potentially a reduced bundle size (see the bundling section later).</p>

<blockquote>
<p><strong>As a side-note:</strong> most of the time services are registered as <code>providedIn: 'root'</code> or if you need more control over the instance, directly on the actual <code>@Component({ providers: [... ]})</code>.</p>

<p>If you use <code>providedIn: DataAccessModule</code> you need to be aware of potential circular dependencies. Why? Well, we know that we need to register Components on an <code>NgModule</code> (at least as of now). If <code>DataAccessModule</code> has a component <code>DetailViewComponent</code> which is registered on the <code>DataAccessModule</code> and also imports <code>DataService</code>, we have a circular dependency: <code>DetailViewComponent -&gt; DataService -&gt; DataAccessModule -&gt; DetailViewComponent</code>. There are ways around that, but for simplicity I would fallback to the NgModule.providers registration at that point.</p>
</blockquote>

<p>With the <code>providedIn: 'root'</code> method, once the lazy loaded chunk containing the service has been registered, it&rsquo;ll be registered at the app&rsquo;s root injector and thus there will only be one global singleton instance. Whenever another module also referencing the service gets loaded, it&rsquo;ll receive the same instance of the service from the dependency injector. This even holds for lazy loaded Angular modules.</p>

<p><strong>Example</strong></p>

<p>Assume the user navigates to <code>/feature1</code> which triggers the lazy loading of <code>Feature1Module</code> and the corresponding <code>Feature1Component</code>. The latter requires an instance of a <code>DataService</code> that gets loaded and since it doesn&rsquo;t exist on the dependency injector yet, it gets registered.</p>

<p>Then the user navigates to <code>feature2</code> which again triggers the lazy loading of <code>Feature2Module</code> and the corresponding <code>Feature2Component</code>. Again, the latter requires an instance of the <code>DataService</code> which at this point already exists globally and thus the in-memory instance will be returned.</p>

<h3 id="bundling-situation-1">Bundling situation</h3>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="//www.youtube.com/embed/cLTMCaiquxc" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


<p>When using the <code>providedIn</code> syntax, the bundling situation depends on how things are referenced.</p>

<p><strong>Option 1: Feature Modules reference DataAccessModule</strong></p>

<p>If <code>Feature1Module</code> and <code>Feature2Module</code> also reference the <code>DataAccessModule</code> in it&rsquo;s <code>imports</code> array, then the bundling situation is exactly the same as described before. We&rsquo;d get a <code>common.js</code> containing both, the <code>DataAccessModule</code> and <code>DataService</code>.</p>

<p><strong>Option 2: Feature Modules just reference the DataService, but not DataAccessModule</strong></p>

<p>We&rsquo;ve learned that the <code>providedIn</code> syntax auto-registers the service on a first usage basis. Thus, if <code>Feature1Module</code> and <code>Feature2Module</code> don&rsquo;t need any logic on the <code>DataAccessModule</code> other than the actual <code>DataService</code>, there&rsquo;s no need to import the <code>DataAccessModule</code> into their corresponding <code>NgModule.imports</code> section. As a result, the <code>DataAccessModule</code> would never be referenced anywhere and thus not get bundled into the <code>common.js</code> chunk.</p>

<p><strong>Option 3: Feature Modules reference the DataAccessModule, but no one the DataService</strong></p>

<p>Assume for some reason the <code>DataService</code> is not used by both, the <code>Feature1Module</code> and <code>Feature2Module</code> .</p>

<p>In the case where the <code>DataAccessModule</code> references the <code>DataService</code> in it&rsquo;s <code>providers</code> array, the <code>DataService</code> would still be bundled into the <code>common.js</code>. If the <code>DataService</code> however uses the <code>providedIn</code> syntax, it would be tree-shaken out and not finish in any bundle. This happens regardless whether we pass <code>root</code> or the <code>NgModule</code> reference to the <code>providedIn</code> property.</p>

<h2 id="thoughts-about-ngrx">Thoughts about NgRx</h2>

<p>When you&rsquo;re using an <a href="https://ngrx.io/">NgRx Store</a> for your data management (and this holds probably for other state management solutions as well), there is some logic you&rsquo;ll have in your <code>AppModule</code> as well as your feature modules. For example:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="c1">// feature1.module.ts
</span><span class="c1"></span>
<span class="kd">@NgModule</span><span class="p">({</span>
  <span class="p">...</span>
  <span class="nx">imports</span><span class="o">:</span> <span class="p">[</span>
    <span class="nx">StoreModule</span><span class="p">.</span><span class="nx">forFeature</span><span class="p">(</span>
      <span class="nx">fromFeature</span><span class="p">.</span><span class="nx">FEATURE1_KEY</span><span class="p">,</span>
      <span class="nx">fromFeature</span><span class="p">.</span><span class="nx">feature1Reducer</span>
    <span class="p">),</span>
    <span class="nx">EffectsModule</span><span class="p">.</span><span class="nx">forFeature</span><span class="p">([</span><span class="nx">Feature1Effects</span><span class="p">])</span>
  <span class="p">]</span>
<span class="p">})</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">Feature1Module</span> <span class="p">{}</span></code></pre></div>
<p>Now assume you use the Facade pattern. That would be an Angular service that could easily use the <code>providedIn</code> syntax. As a result, some user might import the <code>Feature1Facade</code> into some other modules, without importing <code>Feature1Module</code>. However, you need to make sure that the NgRx registration logic in <code>Feature1Module</code> has been executed before, otherwise you might run into a runtime exception where you access <code>Feature1Facade</code> which tries to access some <code>NgRx</code> store data which hasn&rsquo;t been initialized though.</p>

<p>How to solve that? It depends on your architecture setup. You could have a setup where the NgRx setup is always part of the main feature module of your domain, and thus all other lazy loaded modules of that specific domain can rely on the NgRx part to be initialized already. Alternatively, don&rsquo;t use the <code>providedIn</code> syntax and force developers to import the according <code>Feature1Module</code> whenever they want to use that part of the NgRx store.</p>

<p>I&rsquo;m curious what your thoughts are, so <a href="https://twitter.com/juristr">feel free to ping me</a> 😃.</p>

<h2 id="conclusion">Conclusion</h2>

<p>So we&rsquo;ve seen</p>

<ul>
<li>different ways of registering Angular services</li>
<li>the runtime impact of using the <code>providedIn</code> or <code>NgModule.providers</code> registration (e.g. with the number of instances at runtime for lazy loaded modules)</li>
<li>the bundling impact, in that <code>providedIn</code> allows to tree-shake out Angular services that are not being used.</li>
</ul>

<p>So in general I always recommend the <code>providedIn</code> to use as the default. You can then fallback to the <code>NgModule.providers</code> registration or even to the Component level registration if you have a valid reason to do so.</p>

<h3 id="useful-references">Useful References</h3>

<ul>
<li><a href="https://angular.io/guide/hierarchical-dependency-injection">Angular docs - Hierarchical Injectors</a></li>
<li><a href="https://angular.io/guide/architecture-services#providing-services">Angular docs - Tree-shakeable providers</a></li>
</ul>

				<hr />

				Questions? Thoughts? Hit me up <a href="https://twitter.com/juristr" target="_blank">on Twitter</a>
            </div>

            
            <div class="after-post-tags">
                <ul class="tags">
                    
                    <li>
                        <a href="/tags/angular">angular</a>
                    </li>
                    
                </ul>
            </div>
            

            <a href="https://egghead.io/instructors/juri-strumpflohner" class="external-link" data-client="eggheadio"
                data-uid="egghead-instructor-page">
                <img src="/blog/assets/imgs/egghead-banner-learn-with-me.png" style="width:100%" />
            </a>

            
            
            
        </div>
        
    </div>
</div>

<div class="hideshare"></div>



<div class="related-container">
    <div class="container">
        <div class="row listrecent listrelated">
            
            

            <div class="col-md-4">
<div class="card">
    
    <div class="card-block">
        <h2 class="card-title">
            <a href="/blog/2021/02/common-chunk-lazy-loading-angular-cli">Common Chunk and Lazy Loading in Angular</a>
        </h2>
        <h4 class="card-text">
            What is the common chunk, why is it there and how can it be disabled with the Angular CLI
            
        </h4>
        <div class="metafooter">
            <div class="wrapfooter">
                <div class="row">
                    <div class="col-10">
                        
                            <span class="meta-footer-thumb">
                                <a href="/about/">
                                    <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                                </a>
                            </span>
                            <span class="author-meta">
                                <span class="post-name"><a href="/about/">Juri Strumpflohner</a></span><br />
                                <span class="post-date">Feb 17, 2021</span><span class="dot"></span><span
                                    class="post-read">3 min read</span>
                            </span>
                        
                    </div>
                    <div class="col-2">
                        
                        
                        
                        <span class="post-category-icon">
                            
                            
                                <img src="/assets/images/categories/angular.svg" />
                            
                        </span>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    
</div>

            </div>

            

            <div class="col-md-4">
<div class="card">
    
    <div class="card-block">
        <h2 class="card-title">
            <a href="/blog/2020/11/multi-step-automatic-code-migrations">Automatic Multi-Step Code Migrations with Nx</a>
        </h2>
        <h4 class="card-text">
            How the Angular CLI changed the way we think about breaking changes &amp; how Nx is different with its multi-step migration command
            
        </h4>
        <div class="metafooter">
            <div class="wrapfooter">
                <div class="row">
                    <div class="col-10">
                        
                            <span class="meta-footer-thumb">
                                <a href="/about/">
                                    <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                                </a>
                            </span>
                            <span class="author-meta">
                                <span class="post-name"><a href="/about/">Juri Strumpflohner</a></span><br />
                                <span class="post-date">Jan 8, 2021</span><span class="dot"></span><span
                                    class="post-read">4 min read</span>
                            </span>
                        
                    </div>
                    <div class="col-2">
                        
                        
                        
                        <span class="post-category-icon">
                            
                            
                                <img src="/assets/images/categories/angular.svg" />
                            
                        </span>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    
</div>

            </div>

            

            <div class="col-md-4">
<div class="card">
    
    <div class="card-block">
        <h2 class="card-title">
            <a href="/blog/2020/11/get-started-with-nx">I&#39;m new to Nx. Where do I get started?</a>
        </h2>
        <h4 class="card-text">
            Best resources to get up to speed with Nx
            
        </h4>
        <div class="metafooter">
            <div class="wrapfooter">
                <div class="row">
                    <div class="col-10">
                        
                            <span class="meta-footer-thumb">
                                <a href="/about/">
                                    <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                                </a>
                            </span>
                            <span class="author-meta">
                                <span class="post-name"><a href="/about/">Juri Strumpflohner</a></span><br />
                                <span class="post-date">Nov 11, 2020</span><span class="dot"></span><span
                                    class="post-read">2 min read</span>
                            </span>
                        
                    </div>
                    <div class="col-2">
                        
                        
                        
                        <span class="post-category-icon">
                            
                            
                                <img src="/assets/images/categories/nx.svg" />
                            
                        </span>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    
</div>

            </div>

            
            

        </div>
    </div>
</div>

<div class="container">
    <div id="comments" class="row justify-content-center mb-5">
        <div class="col-md-8">              
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "juristr" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>               
        </div>
    </div>
</div>



<script type="text/javascript" src="//downloads.mailchimp.com/js/signup-forms/popup/unique-methods/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script><script type="text/javascript">window.dojoRequire(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us4.list-manage.com","uuid":"04e83acc0ba14b18f30435204","lid":"1d83b68321","uniqueMethods":true}) })</script>
<div class="container">
    
<div class="footer">
    <p class="pull-left">
        &copy; Copyright Juri Strumpflohner - All rights reserved
    </p>
    <p class="pull-right">
        Customized Mediumish Theme, originally by <a target="_blank" href="https://www.wowthemes.net">WowThemes.net</a>
    </p>
    <div class="clearfix">
    </div>
</div>


</div>

    </div>

<script src="/js/jquery.min.js"></script>


<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-throttle-debounce/1.1/jquery.ba-throttle-debounce.min.js"></script>




<script type="text/javascript" src="/js/bundle.js" integrity=""></script>


<script src="/js/jquery.fluidbox.min.js"></script>
<script>
    $('a.image--zoom,.gallery>a').fluidbox();
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-416229-12', 'juristr.com');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
  </script>






    
    <script type="text/javascript">
        window.cookieconsent_options = {
            "message": "This website uses cookies to ensure you get the best experience on our website",
            "dismiss": "Got it!",
            "learnMore": "More info",
            "link": null,
            "theme": "dark-bottom"
        };
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js" defer></script>
    

    
    
    
    <script>
!function(t,e,a,c,x){var s='q';t[s]={publication_id:c,tags:x};
var s=e.createElement(a),r=e.getElementsByTagName(a)[0];s.async=1,s.src=
'https://insights.quiet.ly/app/analytics.min.js',r.parentNode.insertBefore(s,r)}
(window,document,'script','87bcee90-0c51-4a68-a60b-e95df730d1ca','[]');
</script>
    
 <script>
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }
  </script>
</body>

</html>
