<!DOCTYPE html>
<html lang="en-us"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="generator" content="Hugo 0.53" />
	
	<link rel="shortcut icon" href="/assets/images/sitelogo.jpeg">
	
	<title>Hot Reload MDX changes in Next.js and Nx | juri.dev</title>
	
	<meta name="description" content="Learn how to use Next.js, Nx and Tailwind together">
	
	
	<meta name="robots" content="index, follow">

	
	<meta name="author" content="Juri Strumpflohner">
	<link rel="me" href="https://profiles.google.com/104904743888756261987" />
	<link rel="publisher" href='https://plus.google.com/104904743888756261987' />
	<meta property="twitter:account_id" content="14407063" />


	
	<meta name="google-site-verification" content="0_vyoIaeMG1kXR0h-48gy3OaGl8xoiSJsFDxxCTIBMs" />
	<meta name="google-site-verification" content="AvmssSjl_nchNXIqBW8Agb_UjGqvvLP7HXSxBZ9d0cg" />

	
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@juristr" />
	<meta name="twitter:creator" content="@juristr" />
	<meta name="twitter:title" content="Hot Reload MDX changes in Next.js and Nx" />
	
	<meta name="twitter:description" content="Learn how to use Next.js, Nx and Tailwind together" />
	

	
	<meta name="twitter:image:src" content="https://juristr.com/blog/assets/imgs/nextjs-nx-series/hot-reload-background.jpg" />
	

	
	<meta property="og:type" content="article" />
	<meta property="og:title" content="Hot Reload MDX changes in Next.js and Nx" />
	
	<meta property="og:description" content="Learn how to use Next.js, Nx and Tailwind together" />
	
	
	<meta property="og:image" content="https://juristr.com/blog/assets/imgs/nextjs-nx-series/hot-reload-background.jpg" />
	
	<meta property="og:url" content="https://juristr.com/blog/2021/07/fast-refresh-mdx-files-next-and-nx" />
	<meta property="og:site_name" content="juristr.com" />

	
	<link rel="alternate" type="application/rss+xml" title="Juri Strumpflohner" href="//feeds.feedburner.com/juristrumpflohner">
	

	
	<link href="/css/bootstrap.min.css" rel="stylesheet">

	
	
	<link href='//fonts.googleapis.com/css?family=Righteous|Roboto:400,700,900|Source+Code+Pro|Lora:400,700,400italic|Material+Icons'
	 rel='stylesheet' type='text/css'>
	

	

	
	
	
	<link rel="stylesheet" href="/scss/main.min.css" integrity="" media="screen">

	

	

	
	
	<link rel="stylesheet" href="/scss/article.min.css" integrity="" media="screen">
	

	
	
	<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
<header class="navbar-light bg-white fixed-top mediumnavigation nav-down">
    <div class="container">

        
        <div class="row justify-content-center align-items-center brandrow">

            <div class="col-lg-4 col-md-4 col-xs-12 d-none d-md-block hidden-xs customarea">
                <img src="/assets/images/gde.svg" style="height:23px">
                <a href="https://developers.google.com/community/experts/directory/profile/profile-juri_strumpflohner" style="
                    padding-left: 5px;
                    font-size: 15pt;
                ">GDE
                    for Web Tech</a>
                

            </div>

            <div class="col-lg-4 col-md-4  col-xs-12 text-center logoarea">
                <a class="navbar-brand" href="https://juristr.com/">
                    
                    <span style="font-family:Righteous;">juri.dev</span>
                    
                </a>
                
            </div>

            <div class="col-lg-4 col-md-4  col-xs-12 text-right d-none d-md-block">
                <a href="https://twitter.com/juristr" class="twitter-follow-button" data-show-count="true">Follow me!</a>
                <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            </div>

        </div>
        

        <div class="navarea">

            <nav class="navbar navbar-toggleable-sm">
                
                <div id="bs4navbar" class="navbar-collapse">
                    
                    <ul id="menu-top-menu" class="navbar-nav col-md-12 justify-content-center">
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/">Home</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/blog">Blog</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/categories">Collections</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/newsletter">Newsletter</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="https://github.com/juristr/ama">AMA</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/about">About Me</a>
                        </li>
                        
                    </ul>

                    
                </div>
            </nav>

        </div>

    </div>

</header>

    <div class="site-content">



<div class="container page-container">
    <div class="row">
        
        <div class="col-md-2 pl-0"><div class="share">
    <p>
        Share
    </p>
    <ul>
        <li>
            <a target="_blank" href="https://twitter.com/home?status=Check out this post by @juristr https%3a%2f%2fjuristr.com%2fblog%2f2021%2f07%2ffast-refresh-mdx-files-next-and-nx%2f">
                <svg class="svgIcon-use" width="29" height="29" viewbox="0 0 29 29">
                    <path d="M21.967 11.8c.018 5.93-4.607 11.18-11.177 11.18-2.172 0-4.25-.62-6.047-1.76l-.268.422-.038.5.186.013.168.012c.3.02.44.032.6.046 2.06-.026 3.95-.686 5.49-1.86l1.12-.85-1.4-.048c-1.57-.055-2.92-1.08-3.36-2.51l-.48.146-.05.5c.22.03.48.05.75.08.48-.02.87-.07 1.25-.15l2.33-.49-2.32-.49c-1.68-.35-2.91-1.83-2.91-3.55 0-.05 0-.01-.01.03l-.49-.1-.25.44c.63.36 1.35.57 2.07.58l1.7.04L7.4 13c-.978-.662-1.59-1.79-1.618-3.047a4.08 4.08 0 0 1 .524-1.8l-.825.07a12.188 12.188 0 0 0 8.81 4.515l.59.033-.06-.59v-.02c-.05-.43-.06-.63-.06-.87a3.617 3.617 0 0 1 6.27-2.45l.2.21.28-.06c1.01-.22 1.94-.59 2.73-1.09l-.75-.56c-.1.36-.04.89.12 1.36.23.68.58 1.13 1.17.85l-.21-.45-.42-.27c-.52.8-1.17 1.48-1.92 2L22 11l.016.28c.013.2.014.35 0 .52v.04zm.998.038c.018-.22.017-.417 0-.66l-.498.034.284.41a8.183 8.183 0 0 0 2.2-2.267l.97-1.48-1.6.755c.17-.08.3-.02.34.03a.914.914 0 0 1-.13-.292c-.1-.297-.13-.64-.1-.766l.36-1.254-1.1.695c-.69.438-1.51.764-2.41.963l.48.15a4.574 4.574 0 0 0-3.38-1.484 4.616 4.616 0 0 0-4.61 4.613c0 .29.02.51.08.984l.01.02.5-.06.03-.5c-3.17-.18-6.1-1.7-8.08-4.15l-.48-.56-.36.64c-.39.69-.62 1.48-.65 2.28.04 1.61.81 3.04 2.06 3.88l.3-.92c-.55-.02-1.11-.17-1.6-.45l-.59-.34-.14.67c-.02.08-.02.16 0 .24-.01 2.12 1.55 4.01 3.69 4.46l.1-.49-.1-.49c-.33.07-.67.12-1.03.14-.18-.02-.43-.05-.64-.07l-.76-.09.23.73c.57 1.84 2.29 3.14 4.28 3.21l-.28-.89a8.252 8.252 0 0 1-4.85 1.66c-.12-.01-.26-.02-.56-.05l-.17-.01-.18-.01L2.53 21l1.694 1.07a12.233 12.233 0 0 0 6.58 1.917c7.156 0 12.2-5.73 12.18-12.18l-.002.04z"></path>
                </svg>
            </a>
        </li>
        <li>
            <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjuristr.com%2fblog%2f2021%2f07%2ffast-refresh-mdx-files-next-and-nx%2f">
                <svg class="svgIcon-use" width="29" height="29" viewbox="0 0 29 29">
                    <path d="M16.39 23.61v-5.808h1.846a.55.55 0 0 0 .546-.48l.36-2.797a.551.551 0 0 0-.547-.62H16.39V12.67c0-.67.12-.813.828-.813h1.474a.55.55 0 0 0 .55-.55V8.803a.55.55 0 0 0-.477-.545c-.436-.06-1.36-.116-2.22-.116-2.5 0-4.13 1.62-4.13 4.248v1.513H10.56a.551.551 0 0 0-.55.55v2.797c0 .304.248.55.55.55h1.855v5.76c-4.172-.96-7.215-4.7-7.215-9.1 0-5.17 4.17-9.36 9.31-9.36 5.14 0 9.31 4.19 9.31 9.36 0 4.48-3.155 8.27-7.43 9.15M14.51 4C8.76 4 4.1 8.684 4.1 14.46c0 5.162 3.75 9.523 8.778 10.32a.55.55 0 0 0 .637-.543v-6.985a.551.551 0 0 0-.55-.55H11.11v-1.697h1.855a.55.55 0 0 0 .55-.55v-2.063c0-2.02 1.136-3.148 3.03-3.148.567 0 1.156.027 1.597.06v1.453h-.924c-1.363 0-1.93.675-1.93 1.912v1.78c0 .3.247.55.55.55h2.132l-.218 1.69H15.84c-.305 0-.55.24-.55.55v7.02c0 .33.293.59.623.54 5.135-.7 9.007-5.11 9.007-10.36C24.92 8.68 20.26 4 14.51 4"></path>
                </svg>
            </a>
        </li>
    </ul>
    
</div></div>
        
        <div class="col-md-9 col-md-offset-2 col-xs-12">
            <div class="mainheading">

                
                
                
                
                <div class="row post-top-meta">
                    
                    <div class="col-md-2">
                        <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                    </div>
                    <div class="col-md-10">
                        <a class="link-dark" href="/about/">Juri Strumpflohner</a><a href="https://twitter.com/@juristr"
                            class="btn follow">Follow</a>
                        <span class="author-description">Juri is a full stack developer and tech lead with a special passion for the web and frontend development. He creates online videos for <a href="https://egghead.io/instructors/juri-strumpflohner">Egghead.io</a>, writes articles on his blog and for tech magazines, speaks at conferences and holds training workshops. Juri is also a recognized Google Developer Expert in Web Technologies</span>
                        
                    </div>
                    
                </div>
                
                
                
                

                <h1 class="posttitle">Hot Reload MDX changes in Next.js and Nx</h1>
                
                <h2 class="article-subtitle">Learn how to use Next.js, Nx and Tailwind together</h2>
                
                <p>
                    <span class="post-date">
                        <time class="post-date">
                            Jul 15, 2021
                        </time></span>
                    <span class="dot"></span>
                    <span class="post-read">8 min read</span>
                </p>
            </div>

            
            
            

            
            <a href="https://egghead.io/courses/productive-git-for-developers?af=fj2vsx" class="external-link" data-client="eggheadio" data-uid="url">
                <img src="/assets/images/banners/egghead-banner-productive-git.png" style="width:100%" />
            </a>
            

            
            <div class="article-post">
                <div class="article-intro">
    In the <a href="/blog/2021/07/component-hydration-nextjs-nx/">previous article</a> we learned how to use <code>next-mdx-remote</code> to load and hydrate MDX content. In this article, we&rsquo;re going to learn how to implement a custom server for our Next.js app with Nx, that allows us to auto-refresh the rendering whenever something in our MDX files changes.
</div>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9669473064376287" data-ad-slot="2496274486"
    data-ad-format="auto"></ins>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<p><strong>Building a blog with Next.js and Nx Series</strong><br />
This article is part of a series around building a blog with Nx, Next.js, Tailwind, Storybook and Cypress.</p>

<ul>
<li><a href="/blog/2021/06/create-nextjs-webapp-nx">Create a Next.js web app with Nx</a></li>
<li><a href="/blog/2021/06/setup-tailwind-nextjs-and-nx/">Setup Next.js to use Tailwind with Nx</a></li>
<li><a href="/blog/2021/06/read-render-markdown-nextjs-and-nx/">Read and render Markdown files with Next.js and Nx</a></li>
<li><a href="/blog/2021/07/component-hydration-nextjs-nx/">Component hydration with MDX in Next.js and Nx</a></li>
<li><strong>Hot Reload MDX changes in Next.js with Nx</strong></li>
<li>Use Storybook with Next.js, Tailwind and Nx to develop components in isolation  <em>(soon)</em></li>
<li>Use Cypress with Next.js and Nx to battle test your React Components <em>(soon)</em></li>
<li>Publishing a Next.js site to Vercel with Nx <em>(soon)</em></li>
</ul>

<p><em>Check back later, <a href="https://twitter.com/juristr">follow me on Twitter</a> or <a href="/newsletter">subscribe to the Newsletter</a> to get updates about upcoming articles</em></p>

<hr />
<div class="article-toc">
    <strong>Table of contents</strong>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#what-is-fast-refresh-aka-hot-reloading">What is Fast Refresh aka Hot Reloading</a></li>
<li><a href="#using-next-remote-watch">Using <code>next-remote-watch</code></a></li>
<li><a href="#how-it-works">How it works</a></li>
<li><a href="#implementing-fast-refresh">Implementing Fast Refresh</a></li>
<li><a href="#optional-using-an-env-variable-for-our-articles-path">Optional: Using an env variable for our _articles path</a>
<ul>
<li><a href="#step-1-refactor-our-code-to-use-environment-variables">Step 1: Refactor our code to use environment variables</a></li>
<li><a href="#step-2-specify-the-environment-variables">Step 2: Specify the environment variables</a></li>
</ul></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul></li>
</ul>
</nav>
</div>
<hr />

<p>Having the live website (running locally on the computer) automatically refresh and reflect the changes made in Markdown is very convenient while writing a new blog article. The common behavior is to auto-refresh the page whenever something in the markdown (MDX) content changes. While this works for our Next.js components, we have to add support for our MDX files.</p>

<h2 id="what-is-fast-refresh-aka-hot-reloading">What is Fast Refresh aka Hot Reloading</h2>

<p>Here&rsquo;s a quick excerpt from the official <a href="https://nextjs.org/docs/basic-features/fast-refresh">Next.js docs</a>.</p>

<blockquote>
<p>Fast Refresh is a Next.js feature that gives you instantaneous feedback on edits made to your React components. Fast Refresh is enabled by default in all Next.js applications on <strong>9.4 or newer</strong>. With Next.js Fast Refresh enabled, most edits should be visible within a second, <strong>without losing component state</strong>.</p>
</blockquote>

<p>This works out of the box for Next.js and obviously also with the Nx integration. Whenever you change something in a Next.js component, you should see a small Vercel logo appear at the lower right corner of the open browser window, fast refreshing the current page. The important part here is that it doesn&rsquo;t simply do a Browser refresh, but auto reloads the component, thus you should not lose any current component state.</p>

<p>We definitely want this type of behavior also for our MDX pages, so let&rsquo;s see how we can implement that.</p>

<h2 id="using-next-remote-watch">Using <code>next-remote-watch</code></h2>

<p>There&rsquo;s a package <a href="https://github.com/hashicorp/next-remote-watch">next-remote-watch</a> that allows doing exactly that. As their official GitHub account documents, after installing the package, simply change the npm scripts to the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-diff" data-lang="diff">// ...
&#34;scripts&#34;: {
<span class="gd">-  &#34;start&#34;: &#34;next dev&#34;
</span><span class="gd"></span><span class="gi">+  &#34;start&#34;: &#34;next-remote-watch&#34;
</span><span class="gi"></span>}
</code></pre></div>
<blockquote>
<p>⚠️ <strong>WARNING (from the library GitHub repo):</strong> <code>next-remote-watch</code> utilizes undocumented APIs from next.js that are not subject to semantic versioning. This means that any version bump to next.js, major, minor, or patch, could cause it to break without warning. If you decide to adopt this package, you should lock your next.js version to patch, and be careful when upgrading.</p>
</blockquote>

<p>The downside of using this package is that it controls the entire process, so rather than going through <code>next dev</code>, it handles the instantiation of the dev server on its own.</p>

<h2 id="how-it-works">How it works</h2>

<p><code>next-remote-watch</code> uses <code>chokidar</code> to watch for file changes and then invokes a private Next.js API to signal the rebuild and reload of the page.</p>

<p>Something like</p>
<div class="highlight"><pre class="chroma"><code class="language-tsx" data-lang="tsx"><span class="nx">chokidar</span>
  <span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">watchPath</span><span class="p">,</span> <span class="p">{</span> <span class="nx">usePolling</span>: <span class="kt">false</span> <span class="p">})</span>
  <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">filePathContext</span><span class="p">,</span> <span class="nx">eventContext</span> <span class="o">=</span> <span class="s1">&#39;change&#39;</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="c1">// &#34;hotReloader&#34; is a private property on the Next app
</span><span class="c1"></span>    <span class="nx">app</span><span class="p">[</span><span class="s1">&#39;hotReloader&#39;</span><span class="p">].</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;building&#39;</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">[</span><span class="s1">&#39;hotReloader&#39;</span><span class="p">].</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;reloadPage&#39;</span><span class="p">);</span>
  <span class="p">});</span></code></pre></div>
<p><strong>Note:</strong> As you can see, using such a private API is quite risky, so make sure you freeze the Next.js version and you test things accordingly when you upgrade to a new Next.js release.</p>

<h2 id="implementing-fast-refresh">Implementing Fast Refresh</h2>

<p>By using <code>next-remote-watch</code>, all the Nx specific setup is being bypassed, since the script invokes the Next.js development server directly. We can however implement it with Nx ourselves in a quite easy and straightforward way.</p>

<p><a href="https://nx.dev/latest/react/next/server#customserverpath">The Nx Next.js executor</a> (<code>@nrwl/next:server</code>) allows you to implement a custom server.</p>

<p>A custom server is basically a function with a certain signature that we register on our Nx Next.js executor. The file itself can be created wherever we want. We could simply add it to our Next.js app, but since it can be reused across different apps, but isn&rsquo;t really something that would require a dedicated library, I&rsquo;m placing the file in the <code>tools/next-watch-server</code> folder.</p>
<div class="highlight"><pre class="chroma"><code class="language-tsx" data-lang="tsx"><span class="c1">// tools next-watch-server/next-watch-server.ts
</span><span class="c1"></span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">NextServer</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;next/dist/server/next&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">NextServerOptions</span><span class="p">,</span> <span class="nx">ProxyConfig</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;@nrwl/next&#39;</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">nextWatchServer</span><span class="p">(</span>
  <span class="nx">app</span>: <span class="kt">NextServer</span><span class="p">,</span>
  <span class="nx">settings</span>: <span class="kt">NextServerOptions</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="p">[</span><span class="nx">prop</span>: <span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="nx">any</span> <span class="p">},</span>
  <span class="nx">proxyConfig</span>: <span class="kt">ProxyConfig</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span></code></pre></div>
<p>Nx passes the instantiated Next.js app, the settings passed to the executor (these are the options configured in <code>workspace.json</code>) and the proxyConfig (if provided). These properties can then be used to implement the watch logic:</p>
<div class="highlight"><pre class="chroma"><code class="language-tsx" data-lang="tsx"><span class="c1">// tools/next-watch-server/next-watch-server.ts
</span><span class="c1"></span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">NextServer</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;next/dist/server/next&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">NextServerOptions</span><span class="p">,</span> <span class="nx">ProxyConfig</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;@nrwl/next&#39;</span><span class="p">;</span>

<span class="c1">//@ts-check
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">chokidar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;chokidar&#39;</span><span class="p">);</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">nextWatchServer</span><span class="p">(</span>
  <span class="nx">app</span>: <span class="kt">NextServer</span><span class="p">,</span>
  <span class="nx">settings</span>: <span class="kt">NextServerOptions</span> <span class="o">&amp;</span> <span class="p">{</span> <span class="p">[</span><span class="nx">prop</span>: <span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="nx">any</span> <span class="p">},</span>
  <span class="nx">proxyConfig</span>: <span class="kt">ProxyConfig</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">handle</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">getRequestHandler</span><span class="p">();</span>
  <span class="nx">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">prepare</span><span class="p">();</span>

	<span class="kr">const</span> <span class="nx">articlesPath</span> <span class="o">=</span> <span class="s1">&#39;_articles&#39;</span><span class="p">;</span>

  <span class="c1">// watch folders if specified
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">articlesPath</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">chokidar</span>
      <span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">articlesPath</span><span class="p">,</span> <span class="p">{</span> <span class="nx">usePolling</span>: <span class="kt">false</span><span class="p">,</span> <span class="nx">ignoreInitial</span>: <span class="kt">true</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">filePathContext</span><span class="p">,</span> <span class="nx">eventContext</span> <span class="o">=</span> <span class="s1">&#39;change&#39;</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">app</span><span class="p">[</span><span class="s1">&#39;hotReloader&#39;</span><span class="p">].</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;building&#39;</span><span class="p">);</span>
        <span class="nx">app</span><span class="p">[</span><span class="s1">&#39;hotReloader&#39;</span><span class="p">].</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;reloadPage&#39;</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">disable</span><span class="p">(</span><span class="s1">&#39;x-powered-by&#39;</span><span class="p">);</span>

  <span class="c1">// Serve shared assets copied to `public` folder
</span><span class="c1"></span>  <span class="nx">server</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span>
    <span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">conf</span><span class="p">.</span><span class="nx">outdir</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span><span class="p">))</span>
  <span class="p">);</span>

  <span class="c1">// Set up the proxy.
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">proxyConfig</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// eslint-disable-next-line @typescript-eslint/no-var-requires
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">proxyMiddleware</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http-proxy-middleware&#39;</span><span class="p">);</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">proxyConfig</span><span class="p">).</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">server</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">proxyMiddleware</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">proxyConfig</span><span class="p">[</span><span class="nx">context</span><span class="p">]));</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// Default catch-all handler to allow Next.js to handle all other routes
</span><span class="c1"></span>  <span class="nx">server</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">));</span>

  <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">hostname</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>The implementation is basically copying the Nx default Next.js server (<a href="https://github.com/nrwl/nx/blob/master/packages/next/src/executors/server/lib/default-server.ts">see here</a>) and adding the watch implementation using <code>chokidar</code> to watch the specified folder.</p>

<p>Finally, we need to pass the new custom server to the executor configuration in the <code>workspace.json</code></p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&#34;projects&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;site&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;root&#34;</span><span class="p">:</span> <span class="s2">&#34;apps/site&#34;</span><span class="p">,</span>
      <span class="err">...</span>
      <span class="nt">&#34;targets&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="err">...</span>
        <span class="nt">&#34;serve&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;executor&#34;</span><span class="p">:</span> <span class="s2">&#34;@nrwl/next:server&#34;</span><span class="p">,</span>
          <span class="nt">&#34;options&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;buildTarget&#34;</span><span class="p">:</span> <span class="s2">&#34;site:build&#34;</span><span class="p">,</span>
            <span class="nt">&#34;dev&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nt">&#34;customServerPath&#34;</span><span class="p">:</span> <span class="s2">&#34;../../tools/next-watch-server/next-watch-server.ts&#34;</span>
          <span class="p">},</span>
          <span class="err">...</span>
        <span class="p">},</span>
       <span class="err">...</span>
      <span class="p">}</span>
    <span class="p">},</span>
  <span class="p">},</span>
  <span class="err">...</span>
<span class="p">}</span></code></pre></div>
<p>To test this, change something in the current MDX file you&rsquo;re visualizing and hit save. You should see the Next.js fast refresh icon appear at the lower right corner, fast refreshing your changes.</p>


<figure class="image--full">

    
        
        <a href="/blog/assets/imgs/nextjs-nx-series/hot-reload-icon.png" class="image--zoom">
            <img src="/blog/assets/imgs/nextjs-nx-series/hot-reload-icon.png" loading="lazy" class="lazyload"/>
        </a>
    
    <figcaption></figcaption>
</figure>



<h2 id="optional-using-an-env-variable-for-our-articles-path">Optional: Using an env variable for our _articles path</h2>

<p>Right now we have our <code>_articles</code> path in two different places, so it might be something we might want to factor out. By using environment variables for instance.</p>

<h3 id="step-1-refactor-our-code-to-use-environment-variables">Step 1: Refactor our code to use environment variables</h3>

<p>First of all, let&rsquo;s open our <code>[slug].tsx</code> file where we specify our <code>POSTS_PATH</code> variable. let&rsquo;s move it into the <code>getStaticProps</code> and <code>getStaticPaths</code> function as those have full access to the node environment.</p>

<p>Furthermore, we change them as follows:</p>
<div class="highlight"><pre class="chroma"><code class="language-diff" data-lang="diff"><span class="gi">+ const POSTS_PATH = join(process.cwd(), &#39;_articles&#39;);
</span><span class="gi"></span><span class="gd">- const POSTS_PATH = join(process.cwd(), process.env.articleMarkdownPath);
</span><span class="gd"></span></code></pre></div>
<p>Similarly in our <code>tools/next-watch-server/next-watch-server.ts</code></p>
<div class="highlight"><pre class="chroma"><code class="language-diff" data-lang="diff">export default async function nextWatchServer(
  app: NextServer,
  settings: NextServerOptions &amp; { [prop: string]: any },
  proxyConfig: ProxyConfig
) {
  const handle = app.getRequestHandler();
  await app.prepare();

<span class="gd">- const articlesPath = &#39;_articles&#39;;
</span><span class="gd"></span><span class="gi">+ const articlesPath = process.env.articleMarkdownPath;
</span><span class="gi"></span>
  // watch folders if specified
  if (articlesPath) {
    chokidar
      .watch(articlesPath, {
        usePolling: false,
        ignoreInitial: true,
      })
      .on(&#39;all&#39;, async (filePathContext, eventContext = &#39;change&#39;) =&gt; {
        // CAUTION: accessing private APIs
        app[&#39;server&#39;][&#39;hotReloader&#39;].send(&#39;building&#39;);
        app[&#39;server&#39;][&#39;hotReloader&#39;].send(&#39;reloadPage&#39;);
      });
  }
...
</code></pre></div>
<h3 id="step-2-specify-the-environment-variables">Step 2: Specify the environment variables</h3>

<p>Now that we refactored all our hard-coded values, let&rsquo;s go and specify our environment variables. We have two options for that</p>

<ol>
<li>create a <code>.env.local</code> file at the root of our Nx workspace</li>
<li>use the <code>env</code> property in our app&rsquo;s <code>next.config.js</code></li>
</ol>

<p>The Next docs have guides for both, using the <a href="https://nextjs.org/docs/api-reference/next.config.js/environment-variables">Next config</a> as well as <a href="https://nextjs.org/docs/basic-features/environment-variables">creating a <code>.env</code> file</a>. Which one you&rsquo;re using merely depends on the type of environment key. Since we&rsquo;re technically in a monorepo, adding a <code>.env.local</code> key is global to the monorepo and thus would not easily allow us to customize it per application. Instead, specifying the environment variable in the <code>next.config.js</code> of our app, makes the key local to our application.</p>
<div class="highlight"><pre class="chroma"><code class="language-jsx" data-lang="jsx"><span class="c1">// apps/site/next.config.js
</span><span class="c1"></span><span class="k">const</span> <span class="nx">withNx</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@nrwl/next/plugins/with-nx&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">withNx</span><span class="p">({</span>
  
  <span class="c1">// adding a env variable with Next
</span><span class="c1"></span>  <span class="nx">env</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">articleMarkdownPath</span><span class="o">:</span> <span class="s1">&#39;_articles&#39;</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">});</span></code></pre></div>
<p>In this specific example of a blog platform and given we have the <code>_articles</code> folder at root of our monorepo vs within the application itself, I&rsquo;m proceeding with option 1).</p>

<p>At the root of the monorepo, create a new <code>.env.local</code> file and add the following:</p>

<pre><code>articleMarkdownPath = '_articles'
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<p>In this article, we learned</p>

<ul>
<li>What fast refresh is about and what options we have at the moment of writing this article to implement it</li>
<li>How to create a custom Next.js server with Nx and TypeScript</li>
<li>How to use the custom Next.js server to implement fast refresh for our MDX files</li>
<li>How to use environment variables with Next.js and Nx</li>
</ul>

<p>See also:</p>

<ul>
<li><a href="https://nx.dev/latest/react/guides/nextjs">https://nx.dev/latest/react/guides/nextjs</a></li>
<li><a href="https://nx.dev/latest/react/next/server#customserverpath">Nx Next.js executor and <code>customServerPath</code> property</a></li>
<li><a href="https://github.com/hashicorp/next-remote-watch">https://github.com/hashicorp/next-remote-watch</a></li>
</ul>

<p><strong>GitHub repository</strong><br />
All the sources for this article can be found in this GitHub repository’s branch:
<a href="https://github.com/juristr/blog-series-nextjs-nx/tree/05-hot-reload-mdx">https://github.com/juristr/blog-series-nextjs-nx/tree/05-hot-reload-mdx</a></p>

				<hr />

				Questions? Thoughts? Hit me up <a href="https://twitter.com/juristr" target="_blank">on Twitter</a>
            </div>

            
            <div class="after-post-tags">
                <ul class="tags">
                    
                    <li>
                        <a href="/tags/nextjs">nextjs</a>
                    </li>
                    
                    <li>
                        <a href="/tags/TailwindCSS">TailwindCSS</a>
                    </li>
                    
                    <li>
                        <a href="/tags/reactjs">reactjs</a>
                    </li>
                    
                    <li>
                        <a href="/tags/markdown">markdown</a>
                    </li>
                    
                    <li>
                        <a href="/tags/mdx">mdx</a>
                    </li>
                    
                </ul>
            </div>
            

            <a href="https://egghead.io/instructors/juri-strumpflohner" class="external-link" data-client="eggheadio"
                data-uid="egghead-instructor-page">
                <img src="/blog/assets/imgs/egghead-banner-learn-with-me.png" style="width:100%" />
            </a>

            
            
            
        </div>
        
    </div>
</div>

<div class="hideshare"></div>



<div class="related-container">
    <div class="container">
        <div class="row listrecent listrelated">
            
            

            <div class="col-md-4">
<div class="card">
    
    <div class="card-block">
        <h2 class="card-title">
            <a href="/blog/2021/07/component-hydration-nextjs-nx">Component hydration with MDX in Next.js and Nx</a>
        </h2>
        <h4 class="card-text">
            Learn how to use Next.js, Nx and Tailwind together
            
        </h4>
        <div class="metafooter">
            <div class="wrapfooter">
                <div class="row">
                    <div class="col-10">
                        
                            <span class="meta-footer-thumb">
                                <a href="/about/">
                                    <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                                </a>
                            </span>
                            <span class="author-meta">
                                <span class="post-name"><a href="/about/">Juri Strumpflohner</a></span><br />
                                <span class="post-date">Jul 8, 2021</span><span class="dot"></span><span
                                    class="post-read">10 min read</span>
                            </span>
                        
                    </div>
                    <div class="col-2">
                        
                        
                        
                        <span class="post-category-icon">
                            
                            <div class="svgicon" style="width: 140px">
    

    

    

    

    

    

    

    

    

</div><div class="svgicon clean_code"></div>
                            
                        </span>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    
</div>

            </div>

            

            <div class="col-md-4">
<div class="card">
    
    <div class="card-block">
        <h2 class="card-title">
            <a href="/blog/2021/06/read-render-markdown-nextjs-and-nx">Read and render MD files with Next.js and Nx</a>
        </h2>
        <h4 class="card-text">
            Learn how to use Next.js, Nx and Tailwind together
            
        </h4>
        <div class="metafooter">
            <div class="wrapfooter">
                <div class="row">
                    <div class="col-10">
                        
                            <span class="meta-footer-thumb">
                                <a href="/about/">
                                    <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                                </a>
                            </span>
                            <span class="author-meta">
                                <span class="post-name"><a href="/about/">Juri Strumpflohner</a></span><br />
                                <span class="post-date">Jun 23, 2021</span><span class="dot"></span><span
                                    class="post-read">12 min read</span>
                            </span>
                        
                    </div>
                    <div class="col-2">
                        
                        
                        
                        <span class="post-category-icon">
                            
                            <div class="svgicon" style="width: 140px">
    

    

    

    

    

    

    

    

    

</div><div class="svgicon clean_code"></div>
                            
                        </span>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    
</div>

            </div>

            

            <div class="col-md-4">
<div class="card">
    
    <div class="card-block">
        <h2 class="card-title">
            <a href="/blog/2021/06/setup-tailwind-nextjs-and-nx">Setup Next.js to use Tailwind with Nx</a>
        </h2>
        <h4 class="card-text">
            Learn how to use Next.js, Nx and Tailwind together
            
        </h4>
        <div class="metafooter">
            <div class="wrapfooter">
                <div class="row">
                    <div class="col-10">
                        
                            <span class="meta-footer-thumb">
                                <a href="/about/">
                                    <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                                </a>
                            </span>
                            <span class="author-meta">
                                <span class="post-name"><a href="/about/">Juri Strumpflohner</a></span><br />
                                <span class="post-date">Jun 15, 2021</span><span class="dot"></span><span
                                    class="post-read">8 min read</span>
                            </span>
                        
                    </div>
                    <div class="col-2">
                        
                        
                        
                        <span class="post-category-icon">
                            
                            <div class="svgicon" style="width: 140px">
    

    

    

    

    

    

    

    

    

</div><div class="svgicon clean_code"></div>
                            
                        </span>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    
</div>

            </div>

            
            

        </div>
    </div>
</div>

<div class="container">
    <div id="comments" class="row justify-content-center mb-5">
        <div class="col-md-8">              
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "juristr" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>               
        </div>
    </div>
</div>



<script type="text/javascript" src="//downloads.mailchimp.com/js/signup-forms/popup/unique-methods/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script><script type="text/javascript">window.dojoRequire(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us4.list-manage.com","uuid":"04e83acc0ba14b18f30435204","lid":"1d83b68321","uniqueMethods":true}) })</script>
<div class="container">
    
<div class="footer">
    <p class="pull-left">
        &copy; Copyright Juri Strumpflohner - All rights reserved
    </p>
    <p class="pull-right">
        Customized Mediumish Theme, originally by <a target="_blank" href="https://www.wowthemes.net">WowThemes.net</a>
    </p>
    <div class="clearfix">
    </div>
</div>


</div>

    </div>

<script src="/js/jquery.min.js"></script>


<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-throttle-debounce/1.1/jquery.ba-throttle-debounce.min.js"></script>




<script type="text/javascript" src="/js/bundle.js" integrity=""></script>


<script src="/js/jquery.fluidbox.min.js"></script>
<script>
    $('a.image--zoom,.gallery>a').fluidbox();
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-416229-12', 'juristr.com');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
  </script>






    
    <script type="text/javascript">
        window.cookieconsent_options = {
            "message": "This website uses cookies to ensure you get the best experience on our website",
            "dismiss": "Got it!",
            "learnMore": "More info",
            "link": null,
            "theme": "dark-bottom"
        };
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js" defer></script>
    

    
    
    
    <script>
!function(t,e,a,c,x){var s='q';t[s]={publication_id:c,tags:x};
var s=e.createElement(a),r=e.getElementsByTagName(a)[0];s.async=1,s.src=
'https://insights.quiet.ly/app/analytics.min.js',r.parentNode.insertBefore(s,r)}
(window,document,'script','87bcee90-0c51-4a68-a60b-e95df730d1ca','[]');
</script>
    
 <script>
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }
  </script>
</body>

</html>
