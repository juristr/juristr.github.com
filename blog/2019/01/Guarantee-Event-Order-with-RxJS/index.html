<!DOCTYPE html>
<html lang="en-us"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="generator" content="Hugo 0.53" />
	
	<link rel="shortcut icon" href="/assets/images/sitelogo.jpeg">
	
	<title>Guarantee Event Order with RxJS | juri.dev</title>
	
	<meta name="description" content="use concatMap to guarantee ordering of events">
	
	
	<meta name="robots" content="index, follow">

	
	<meta name="author" content="Juri Strumpflohner">
	<link rel="me" href="https://profiles.google.com/104904743888756261987" />
	<link rel="publisher" href='https://plus.google.com/104904743888756261987' />
	<meta property="twitter:account_id" content="14407063" />


	
	<meta name="google-site-verification" content="0_vyoIaeMG1kXR0h-48gy3OaGl8xoiSJsFDxxCTIBMs" />
	<meta name="google-site-verification" content="AvmssSjl_nchNXIqBW8Agb_UjGqvvLP7HXSxBZ9d0cg" />

	
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content="@juristr" />
	<meta name="twitter:title" content="Guarantee Event Order with RxJS" />
	
	<meta name="twitter:description" content="use concatMap to guarantee ordering of events" />
	

	
	<meta name="twitter:image:src" content="https://juristr.com/blog/assets/imgs/rxjs-order-guarantee.png" />
	

	
	<meta property="og:type" content="article" />
	<meta property="og:title" content="Guarantee Event Order with RxJS" />
	
	<meta property="og:description" content="use concatMap to guarantee ordering of events" />
	
	
	<meta property="og:image" content="https://juristr.com/blog/assets/imgs/rxjs-order-guarantee.png" />
	
	<meta property="og:url" content="https://juristr.com/blog/2019/01/Guarantee-Event-Order-with-RxJS/" />
	<meta property="og:site_name" content="juristr.com" />

	
	<link rel="alternate" type="application/rss+xml" title="Juri Strumpflohner" href="//feeds.feedburner.com/juristrumpflohner">
	

	
	<link href="/css/bootstrap.min.css" rel="stylesheet">

	
	
	<link href='//fonts.googleapis.com/css?family=Righteous|Roboto:400,700,900|Source+Code+Pro|Lora:400,700,400italic|Material+Icons'
	 rel='stylesheet' type='text/css'>
	

	

	
	
	
	<link rel="stylesheet" href="/scss/main.min.css" integrity="" media="screen">

	

	

	
	
	<link rel="stylesheet" href="/scss/article.min.css" integrity="" media="screen">
	

	
	
</head><body>
<header class="navbar-light bg-white fixed-top mediumnavigation nav-down">
    <div class="container">

        
        <div class="row justify-content-center align-items-center brandrow">

            <div class="col-lg-4 col-md-4 col-xs-12 d-none d-md-block hidden-xs customarea">
                <img src="/assets/images/gde.svg" style="height:23px">
                <a href="https://google-developers.appspot.com/community/experts/directory/profile/profile-juri_strumpflohner" style="
                    padding-left: 5px;
                    font-size: 15pt;
                ">GDE
                    for Web Tech</a>
                

            </div>

            <div class="col-lg-4 col-md-4  col-xs-12 text-center logoarea">
                <a class="navbar-brand" href="https://juristr.com/">
                    
                    <span style="font-family:Righteous;">juri.dev</span>
                    
                </a>
                
            </div>

            <div class="col-lg-4 col-md-4  col-xs-12 text-right d-none d-md-block">
                <a href="https://twitter.com/juristr" class="twitter-follow-button" data-show-count="true">Follow me!</a>
                <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            </div>

        </div>
        

        <div class="navarea">

            <nav class="navbar navbar-toggleable-sm">
                
                <div id="bs4navbar" class="navbar-collapse">
                    
                    <ul id="menu-top-menu" class="navbar-nav col-md-12 justify-content-center">
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/">Home</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/blog">Blog</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/categories">Collections</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/newsletter">Newsletter</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="https://github.com/juristr/ama">AMA</a>
                        </li>
                        
                        <li class="menu-item ">
                            <a class="nav-link" href="/about">About Me</a>
                        </li>
                        
                    </ul>

                    
                </div>
            </nav>

        </div>

    </div>

</header>

    <div class="site-content">



<div class="container page-container">
    <div class="row">
        
        <div class="col-md-2 pl-0"><div class="share">
    <p>
        Share
    </p>
    <ul>
        <li>
            <a target="_blank" href="https://twitter.com/home?status=Check out this post by @juristr https%3a%2f%2fjuristr.com%2fblog%2f2019%2f01%2fGuarantee-Event-Order-with-RxJS%2f">
                <svg class="svgIcon-use" width="29" height="29" viewbox="0 0 29 29">
                    <path d="M21.967 11.8c.018 5.93-4.607 11.18-11.177 11.18-2.172 0-4.25-.62-6.047-1.76l-.268.422-.038.5.186.013.168.012c.3.02.44.032.6.046 2.06-.026 3.95-.686 5.49-1.86l1.12-.85-1.4-.048c-1.57-.055-2.92-1.08-3.36-2.51l-.48.146-.05.5c.22.03.48.05.75.08.48-.02.87-.07 1.25-.15l2.33-.49-2.32-.49c-1.68-.35-2.91-1.83-2.91-3.55 0-.05 0-.01-.01.03l-.49-.1-.25.44c.63.36 1.35.57 2.07.58l1.7.04L7.4 13c-.978-.662-1.59-1.79-1.618-3.047a4.08 4.08 0 0 1 .524-1.8l-.825.07a12.188 12.188 0 0 0 8.81 4.515l.59.033-.06-.59v-.02c-.05-.43-.06-.63-.06-.87a3.617 3.617 0 0 1 6.27-2.45l.2.21.28-.06c1.01-.22 1.94-.59 2.73-1.09l-.75-.56c-.1.36-.04.89.12 1.36.23.68.58 1.13 1.17.85l-.21-.45-.42-.27c-.52.8-1.17 1.48-1.92 2L22 11l.016.28c.013.2.014.35 0 .52v.04zm.998.038c.018-.22.017-.417 0-.66l-.498.034.284.41a8.183 8.183 0 0 0 2.2-2.267l.97-1.48-1.6.755c.17-.08.3-.02.34.03a.914.914 0 0 1-.13-.292c-.1-.297-.13-.64-.1-.766l.36-1.254-1.1.695c-.69.438-1.51.764-2.41.963l.48.15a4.574 4.574 0 0 0-3.38-1.484 4.616 4.616 0 0 0-4.61 4.613c0 .29.02.51.08.984l.01.02.5-.06.03-.5c-3.17-.18-6.1-1.7-8.08-4.15l-.48-.56-.36.64c-.39.69-.62 1.48-.65 2.28.04 1.61.81 3.04 2.06 3.88l.3-.92c-.55-.02-1.11-.17-1.6-.45l-.59-.34-.14.67c-.02.08-.02.16 0 .24-.01 2.12 1.55 4.01 3.69 4.46l.1-.49-.1-.49c-.33.07-.67.12-1.03.14-.18-.02-.43-.05-.64-.07l-.76-.09.23.73c.57 1.84 2.29 3.14 4.28 3.21l-.28-.89a8.252 8.252 0 0 1-4.85 1.66c-.12-.01-.26-.02-.56-.05l-.17-.01-.18-.01L2.53 21l1.694 1.07a12.233 12.233 0 0 0 6.58 1.917c7.156 0 12.2-5.73 12.18-12.18l-.002.04z"></path>
                </svg>
            </a>
        </li>
        <li>
            <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjuristr.com%2fblog%2f2019%2f01%2fGuarantee-Event-Order-with-RxJS%2f">
                <svg class="svgIcon-use" width="29" height="29" viewbox="0 0 29 29">
                    <path d="M16.39 23.61v-5.808h1.846a.55.55 0 0 0 .546-.48l.36-2.797a.551.551 0 0 0-.547-.62H16.39V12.67c0-.67.12-.813.828-.813h1.474a.55.55 0 0 0 .55-.55V8.803a.55.55 0 0 0-.477-.545c-.436-.06-1.36-.116-2.22-.116-2.5 0-4.13 1.62-4.13 4.248v1.513H10.56a.551.551 0 0 0-.55.55v2.797c0 .304.248.55.55.55h1.855v5.76c-4.172-.96-7.215-4.7-7.215-9.1 0-5.17 4.17-9.36 9.31-9.36 5.14 0 9.31 4.19 9.31 9.36 0 4.48-3.155 8.27-7.43 9.15M14.51 4C8.76 4 4.1 8.684 4.1 14.46c0 5.162 3.75 9.523 8.778 10.32a.55.55 0 0 0 .637-.543v-6.985a.551.551 0 0 0-.55-.55H11.11v-1.697h1.855a.55.55 0 0 0 .55-.55v-2.063c0-2.02 1.136-3.148 3.03-3.148.567 0 1.156.027 1.597.06v1.453h-.924c-1.363 0-1.93.675-1.93 1.912v1.78c0 .3.247.55.55.55h2.132l-.218 1.69H15.84c-.305 0-.55.24-.55.55v7.02c0 .33.293.59.623.54 5.135-.7 9.007-5.11 9.007-10.36C24.92 8.68 20.26 4 14.51 4"></path>
                </svg>
            </a>
        </li>
    </ul>
    
</div></div>
        
        <div class="col-md-9 col-md-offset-2 col-xs-12">
            <div class="mainheading">

                
                
                
                
                <div class="row post-top-meta">
                    
                    <div class="col-md-2">
                        <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                    </div>
                    <div class="col-md-10">
                        <a class="link-dark" href="/about/">Juri Strumpflohner</a><a href="https://twitter.com/@juristr"
                            class="btn follow">Follow</a>
                        <span class="author-description">Juri is a full stack developer and tech lead with a special passion for the web and frontend development. He creates online videos for <a href="https://egghead.io/instructors/juri-strumpflohner">Egghead.io</a>, writes articles on his blog and for tech magazines, speaks at conferences and holds training workshops. Juri is also a recognized Google Developer Expert in Web Technologies</span>
                        
                    </div>
                    
                </div>
                
                
                
                

                <h1 class="posttitle">Guarantee Event Order with RxJS</h1>
                
                <h2 class="article-subtitle">use concatMap to guarantee ordering of events</h2>
                
                <p>
                    <span class="post-date">
                        <time class="post-date">
                            Jan 16, 2019
                        </time></span>
                    <span class="dot"></span>
                    <span class="post-read">7 min read</span>
                </p>
            </div>

            
            
            

            
            <a href="https://egghead.io/courses/productive-git-for-developers" class="external-link" data-client="eggheadio" data-uid="url">
                <img src="/assets/images/banners/egghead-banner-productive-git.png" style="width:100%" />
            </a>
            

            
            <div class="article-post">
                <div class="article-intro">
  When you create dynamic UIs, you have to deal with async stuff a lot. Most often they are triggered by some user interaction. Things usually get tricky when you need to guarantee certain operations are executed in order. Since they are async we might not know which one returns first. Let's see how RxJS can help a lot here.
</div>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9669473064376287" data-ad-slot="2496274486"
    data-ad-format="auto"></ins>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<p>In order to illustrate <strong>the problem</strong> I created an example use case, simplified of course, but still it represents a potential real world use case.</p>

<div class="article-toc">
    <strong>Table of contents</strong>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#tl-dr-here-s-the-corresponding-egghead-lesson">TL;DR: Here&rsquo;s the corresponding Egghead lesson</a></li>
<li><a href="#the-problem">The Problem</a></li>
<li><a href="#we-need-to-guarantee-ordering">We need to guarantee ordering</a>
<ul>
<li>
<ul>
<li><a href="#a-short-note-on-wrapping-settimeout-as-observable">A short note on wrapping <code>setTimeout</code> as Observable</a></li>
</ul></li>
<li><a href="#the-entire-concatmap-example">The entire <code>concatMap</code> example</a></li>
</ul></li>
<li><a href="#optimizing-with-switchmap">Optimizing with <code>switchMap</code></a></li>
<li><a href="#switchmap-potential-race-conditions"><code>switchMap</code> - potential race conditions</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul></li>
</ul>
</nav>
</div>

<p>We basically have the following user interface:</p>

<figure class="image--medium">
  <img src="/blog/assets/imgs/rxjs-order-guarantee.png" />
</figure>

<p>When the user <strong>checks</strong> some option, an http request is made to retrieve some value and once the request returns, the response is added to a list visualized below.</p>

<blockquote>
<p>For the sake of simplicity, in this fake example I simply use a <code>setTimeout(..)</code> to simulate the asyncronous request.</p>
</blockquote>

<p>When the user again <strong>deselects</strong> the option, the corresponding value is removed from the list below (without any async request).</p>

<h2 id="tl-dr-here-s-the-corresponding-egghead-lesson">TL;DR: Here&rsquo;s the corresponding Egghead lesson</h2>

<div class="egghead-video-embed">
    <iframe src="https://egghead.io/lessons/angular-guarantee-ordering-of-events-with-rxjs/embed" width="100%" height="500px" loading="lazy"> </iframe>
    <a href="https://egghead.io/lessons/angular-guarantee-ordering-of-events-with-rxjs" class="external-link" data-client="eggheadio" data-uid="lessons/angular-guarantee-ordering-of-events-with-rxjs">View
        on
        Egghead.io</a>
</div>

<h2 id="the-problem">The Problem</h2>

<p>The async request made when checking an option might take a while before coming back of course. That said, what happens when the user double-clicks ðŸ˜•?</p>

<p>Well, try by yourself:</p>

<iframe src="https://stackblitz.com/edit/blog-guarantee-order-wrong?ctl=1&embed=1" width="100%" height="500px" loading="lazy"> </iframe>

<p>As you can see, we might get an inconsistent state. When - for instance - quickly double-clicking on &ldquo;Option 1&rdquo; we get the option selected &amp; then unselected again, but the async call coming later still adds the option to the list.</p>

<p>The issue is quite clear by looking at what happens in the checkbox selection event:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="p">...</span>
<span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">checkboxEvent</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// simulate async call
</span><span class="c1"></span>    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// add the record
</span><span class="c1"></span>      <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">option</span><span class="p">)</span>
    <span class="p">},</span> <span class="mi">1500</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// remove the record given by the id (if present)
</span><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">records</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">value</span> <span class="o">!==</span> <span class="nx">id</span> <span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>The slower async call comes back later, thus it adds the record, regardless of whether we unchecked it again in the meantime.</p>

<h2 id="we-need-to-guarantee-ordering">We need to guarantee ordering</h2>

<p>We somehow need to guarantee ordering of the events. Thus, when double-clicking, we need to make sure that the logic for &ldquo;unchecking&rdquo; is executed only after a potential async call returns. Implementing this can be quite tricky. You could check whether the corresponding option is still checked when the async call returns and only in that case execute the logic. Alternatively, you could hold some flag, blocking other logic to be executed while an async call is running&hellip;<br />
Not really satisfying and hacky.., and again, this is just a small simple fake example.</p>

<p>Well, turns out that if you know RxJS, this is quite easily achievable: using the <code>concatMap</code> operator.</p>

<blockquote class="emphasized">
  <code>concatMap</code> - Map values to inner observable, subscribe and emit in order.
</blockquote>

<p><strong>The idea is to pipe the events</strong> from the checking/unchecking into a RxJS subject and then process them one after the other.</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="kr">private</span> <span class="nx">selectionSubject</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subject</span><span class="o">&lt;</span><span class="nx">SelectionEvent</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">...</span>
<span class="k">this</span><span class="p">.</span><span class="nx">selectionEvent</span>
  <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">concatMap</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="p">...</span>
    <span class="p">})</span>
  <span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">action</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">})</span></code></pre></div>
<p>Inside the <code>concatMap</code> we implement the logic of handling the actions.</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="p">...</span>
<span class="p">.</span><span class="nx">concatMap</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">checkboxEvent</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/*
</span><span class="cm">      do the async call and then return
</span><span class="cm">      an action object like
</span><span class="cm">      {
</span><span class="cm">        type: &#39;ADD&#39;,
</span><span class="cm">        data: ...
</span><span class="cm">      }
</span><span class="cm">    */</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="cm">/*
</span><span class="cm">      Nothing to call, just remove
</span><span class="cm">      the corresponding record, thus return
</span><span class="cm">      a &#34;remove&#34; action
</span><span class="cm">      {
</span><span class="cm">        type: &#39;REMOVE&#39;,
</span><span class="cm">        data: id
</span><span class="cm">      }
</span><span class="cm">    */</span>
  <span class="p">}</span>
<span class="p">})</span>
<span class="p">...</span></code></pre></div>
<p>When we receive a checked event, then we execute the async call, otherwise we trigger an action for removing the item from the list. We need to always return an Observable for that. <code>concatMap</code> subscribes to that &ldquo;inner Observable&rdquo; and proceeds with the next only once the previous one &ldquo;completes&rdquo;, thus <strong>guaranteeing ordering of our events</strong>.</p>

<blockquote>
<p>An Observable &ldquo;completes&rdquo; once it is done. It is similar to the <code>resolve(..)</code> of a <code>Promise</code>.</p>
</blockquote>

<h4 id="a-short-note-on-wrapping-settimeout-as-observable">A short note on wrapping <code>setTimeout</code> as Observable</h4>

<p>You remember we use <code>setTimeout</code> to simulate an async call. Well, we need to wrap it into an Observable. There are two ways of doing it.</p>

<p><strong>Using the <code>timer</code> observable</strong> - we can simply use the existing <code>timer(..)</code> which the RxJS exposes for us:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">timer</span><span class="p">(</span><span class="mi">1500</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">map</span><span class="p">(</span><span class="nx">_</span> <span class="o">=&gt;</span> <span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;ADD&#39;</span><span class="p">,</span>
      <span class="nx">data</span>: <span class="kt">...</span>
    <span class="p">}))</span>
  <span class="p">)</span></code></pre></div>
<p>Alternatively, we <strong>can create an Observable by ourselves</strong> with <code>Observable.create(...)</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">return</span> <span class="nx">Observable</span><span class="p">.</span><span class="nx">create</span><span class="p">((</span><span class="nx">observer</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Returning data&#39;</span><span class="p">);</span>
    <span class="nx">observer</span><span class="p">.</span><span class="nx">next</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;ADD&#39;</span><span class="p">,</span>
      <span class="nx">data</span>: <span class="kt">data.option</span>
    <span class="p">});</span>
    
    <span class="c1">// complete the observable
</span><span class="c1"></span>    <span class="nx">observer</span><span class="p">.</span><span class="nx">complete</span><span class="p">();</span>
  <span class="p">},</span> <span class="mi">1500</span><span class="p">);</span>

  <span class="c1">// cancel timeout on unsubscribe
</span><span class="c1"></span>  <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="p">);</span>
<span class="p">});</span></code></pre></div>
<h3 id="the-entire-concatmap-example">The entire <code>concatMap</code> example</h3>

<p>Alright, now that we know how to wrap our <code>setTimeout</code> as an observable, let&rsquo;s continue with the implementation of the <code>concatMap</code> logic.</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">concatMap</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">checkboxEvent</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// simulate async call
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">Observable</span><span class="p">.</span><span class="nx">create</span><span class="p">((</span><span class="nx">observer</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Returning data&#39;</span><span class="p">);</span>
        <span class="nx">observer</span><span class="p">.</span><span class="nx">next</span><span class="p">({</span>
          <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;ADD&#39;</span><span class="p">,</span>
          <span class="nx">data</span>: <span class="kt">data.option</span>
        <span class="p">});</span>
        <span class="nx">observer</span><span class="p">.</span><span class="nx">complete</span><span class="p">();</span>
      <span class="p">},</span> <span class="mi">1500</span><span class="p">);</span>

      <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">of</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;REMOVE&#39;</span><span class="p">,</span>
      <span class="nx">data</span>: <span class="kt">id</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">})</span></code></pre></div>
<p>In the <code>.subscribe(...)</code> of our <code>selectionObject</code> we then effectively parse the action and cause the side-effect on our result list:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"> <span class="k">this</span><span class="p">.</span><span class="nx">selectionSubject</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
      <span class="nx">concatMap</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="p">...</span>
      <span class="p">})</span>
    <span class="p">).</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">action</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;ADD&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">records</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">x</span> <span class="o">=&gt;</span> <span class="nx">x</span><span class="p">.</span><span class="nx">value</span> <span class="o">!==</span> <span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span></code></pre></div>
<p>Awesome! Now, whenever the user clicks a checkbox, in the according event handler, we don&rsquo;t implement the logic, but rather we just need to pipe it into the <code>selectionSubject</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">onCheckListChange</span><span class="p">(</span><span class="nx">data</span>: <span class="kt">SelectionEvent</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">selectionSubject</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>Here&rsquo;s the according Stackblitz example to play around with. Check it out, double-clicking works perfectly now!</p>

<iframe src="https://stackblitz.com/edit/blog-guarantee-order-concatmap?ctl=1&embed=1" width="100%" height="500px" loading="lazy"> </iframe>

<h2 id="optimizing-with-switchmap">Optimizing with <code>switchMap</code></h2>

<p>But can do even better. In the current <code>concatMap</code> example, when the user double-clicks, we effectively wait until the async call comes back and then remove it again. But why even execute the async logic. When the user double-clicks we can just abort the previous action and not even execute it, thus save time.</p>

<p>That&rsquo;s what <code>switchMap</code> does. In contrast to <code>concatMap</code>, it doesn&rsquo;t execute the actions (our Observable events) in sequence, but rather it cancels the previous Observable.</p>

<blockquote>
<p><strong>Watch out!!</strong> While for this use-case <em>cancelling</em> was an option, this might not always be the case. So be careful to evaluate between using <code>concatMap</code> or <code>switchMap</code>.</p>
</blockquote>

<p>Here&rsquo;s a Stackblitz example. Pay particular attention to the console log. In the <code>setTimeout(..)</code> a log is written (<code>console.log('Returning data');</code>). If you double-click, that log doesn&rsquo;t even appear, proving that the async action is not even executed.</p>

<iframe src="https://stackblitz.com/edit/blog-guarantee-order-switchmap?ctl=1&embed=1" width="100%" height="500px" loading="lazy"> </iframe>

<h2 id="switchmap-potential-race-conditions"><code>switchMap</code> - potential race conditions</h2>

<p>Ok, so we&rsquo;ve learned, that with <code>switchMap</code> we can optimize our <code>concatMap</code> approach in that we cancel the previous observable, thus preventing from even executing that (possibly costly logic) in case when the user double-clicks on one of our checkboxes. But there&rsquo;s a caveaut here: <strong>what if the user quickly clicks the 1st and then 2nd checkbox?</strong> We would actually cancel the click of the 1st checkbox, thus preventing it from being properly activated. Let&rsquo;s see how to fix that.</p>

<p><a href="https://mobile.twitter.com/KwintenP">Kwinten</a> suggested to use <code>mergeMap</code> in this case and then handling the &ldquo;cancelling&rdquo; optimization by using the <code>takeUntil</code> operator, verifying whether a second event from the same checkbox comes in. Here&rsquo;s how to achieve that:</p>
<div class="highlight"><pre class="chroma"><code class="language-typescript" data-lang="typescript"><span class="k">this</span><span class="p">.</span><span class="nx">selectionSubject</span>
  <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="nx">mergeMap</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">checkboxEvent</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Observable</span><span class="p">.</span><span class="nx">create</span><span class="p">((</span><span class="nx">observer</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="p">...</span>
        <span class="p">}).</span><span class="nx">pipe</span><span class="p">(</span>
          <span class="nx">takeUntil</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectionSubject</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
            <span class="nx">filter</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="nx">id</span><span class="p">),</span>
          <span class="p">))</span>
        <span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">of</span><span class="p">({</span>
          <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;REMOVE&#39;</span><span class="p">,</span>
          <span class="nx">data</span>: <span class="kt">id</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">)</span>
  <span class="p">).</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">action</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">});</span></code></pre></div>
<p>As you can see the &ldquo;async&rdquo; observable has a <code>takeUntil</code> that stops that Observable the moment a new event comes in on our <code>selectionSubject</code> with the same id we&rsquo;re currently processing. Because that&rsquo;s the scenario of a double-click on the same checkbox. In any other case, we just complete the observable and let it go on without terminating it, thus solving the potential issue of quickly clicking multiple different checkboxes ðŸ˜ƒ.</p>

<p>And here&rsquo;s the according modified Stackblitz to play around with.</p>

<iframe src="https://stackblitz.com/edit/blog-guarantee-order-mergemap?ctl=1&embed=1" width="100%" height="500px" loading="lazy"> </iframe>

<h2 id="conclusion">Conclusion</h2>

<p>This article demonstrates some pratical use cases for <code>concatMap</code> as well as <code>switchMap</code>. RxJS is powerful, and we see in this example how to solve the &ldquo;ordering&rdquo; problem in a very elegant and maintainable way.</p>

<p>RxJS has its learning curve, though. I highly believe the best way to learn it is not by learning its operators, but rather by real-world use cases and how to solve them with RxJS. Stay tuned for further articles like this one.</p>

<p><em>(@rxjs experts: nothing for you here, I&rsquo;m sorry ðŸ˜‰)</em></p>

				<hr />

				Questions? Thoughts? Hit me up <a href="https://twitter.com/juristr" target="_blank">on Twitter</a>
            </div>

            
            <div class="after-post-tags">
                <ul class="tags">
                    
                    <li>
                        <a href="/tags/RxJS">RxJS</a>
                    </li>
                    
                    <li>
                        <a href="/tags/Angular">Angular</a>
                    </li>
                    
                    <li>
                        <a href="/tags/async">async</a>
                    </li>
                    
                    <li>
                        <a href="/tags/ordering">ordering</a>
                    </li>
                    
                    <li>
                        <a href="/tags/concatMap">concatMap</a>
                    </li>
                    
                    <li>
                        <a href="/tags/switchMap">switchMap</a>
                    </li>
                    
                    <li>
                        <a href="/tags/mergeMap">mergeMap</a>
                    </li>
                    
                </ul>
            </div>
            

            <a href="https://egghead.io/instructors/juri-strumpflohner" class="external-link" data-client="eggheadio"
                data-uid="egghead-instructor-page">
                <img src="/blog/assets/imgs/egghead-banner-learn-with-me.png" style="width:100%" />
            </a>

            
            
            
        </div>
        
    </div>
</div>

<div class="hideshare"></div>



<div class="related-container">
    <div class="container">
        <div class="row listrecent listrelated">
            
            

            <div class="col-md-4">
<div class="card">
    
    <div class="card-block">
        <h2 class="card-title">
            <a href="/blog/2016/01/learning-ng2-dynamic-styles">Learning Angular: Conditionally add styles to an element</a>
        </h2>
        <h4 class="card-text">
            Learn how to conditionally add styles to a DOM element in Angular
            
        </h4>
        <div class="metafooter">
            <div class="wrapfooter">
                <div class="row">
                    <div class="col-10">
                        
                            <span class="meta-footer-thumb">
                                <a href="/about/">
                                    <img class="author-thumb" src="https://www.gravatar.com/avatar/64537dfe80f44978663e378d375c7138?s=150&amp;d=identicon&amp;r=PG" alt="Juri Strumpflohner">
                                </a>
                            </span>
                            <span class="author-meta">
                                <span class="post-name"><a href="/about/">Juri Strumpflohner</a></span><br />
                                <span class="post-date">Jan 25, 2016</span><span class="dot"></span><span
                                    class="post-read">8 min read</span>
                            </span>
                        
                    </div>
                    <div class="col-2">
                        
                        
                        
                        <span class="post-category-icon">
                            
                            
                                <img src="/assets/images/categories/angular.svg" />
                            
                        </span>
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    
</div>

            </div>

            
            

        </div>
    </div>
</div>

<div class="container">
    <div id="comments" class="row justify-content-center mb-5">
        <div class="col-md-8">              
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "juristr" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>               
        </div>
    </div>
</div>



<script type="text/javascript" src="//downloads.mailchimp.com/js/signup-forms/popup/unique-methods/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script><script type="text/javascript">window.dojoRequire(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us4.list-manage.com","uuid":"04e83acc0ba14b18f30435204","lid":"1d83b68321","uniqueMethods":true}) })</script>
<div class="container">
    
<div class="footer">
    <p class="pull-left">
        &copy; Copyright Juri Strumpflohner - All rights reserved
    </p>
    <p class="pull-right">
        Customized Mediumish Theme, originally by <a target="_blank" href="https://www.wowthemes.net">WowThemes.net</a>
    </p>
    <div class="clearfix">
    </div>
</div>


</div>

    </div>

<script src="/js/jquery.min.js"></script>


<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-throttle-debounce/1.1/jquery.ba-throttle-debounce.min.js"></script>




<script type="text/javascript" src="/js/bundle.js" integrity=""></script>


<script src="/js/jquery.fluidbox.min.js"></script>
<script>
    $('a.image--zoom,.gallery>a').fluidbox();
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-416229-12', 'juristr.com');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
  </script>






    
    <script type="text/javascript">
        window.cookieconsent_options = {
            "message": "This website uses cookies to ensure you get the best experience on our website",
            "dismiss": "Got it!",
            "learnMore": "More info",
            "link": null,
            "theme": "dark-bottom"
        };
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js"></script>
    

    
    
    <script src="https://assets.digitalclimatestrike.net/widget.js" async></script>
</body>

</html>