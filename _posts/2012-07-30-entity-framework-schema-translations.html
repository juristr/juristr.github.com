---
layout: post
title: "Entity Framework Schema Translations"
date: 2012-07-30
comments: true
tags: [  Entity Framework, .Net ]
---

<p>You should have <a href="http://blog.js-development.com/2008/09/best-practices-deploying-webapps.html" target="_blank">different setup environments</a>, right. Normally something like dev, test (or staging) and production. This implies to have different DBs as well. At work we have Oracle databases and there we don't really have different DB "instances" but different schemas, depending on the environment we deploy to. This post presents an approach of allowing to dynamically "rewrite" the schema defined in the EF mappings in an easy to use way.</p>

<h2>The Problem</h2><div>When you define a mapping in Entity Framework (I'm talking about <b>database first</b>, don't know whether this applies to code first as well) you'll get an EntitySet section which looks something like this:</div><pre class="brush:xml;highlight:[4]">&lt;EntitySet Name="ADDRESSES" <br />    EntityType="Siag.IAM.Transversal.Entities.Store.ADDRESSES" <br />    store:Type="Tables" <br />    Schema="MYSCHEMA" <br />    Table="ADDRESSES" /&gt;</pre>Note that this is the xml file generated by the <a href="http://www.devart.com/entitydeveloper/" target="_blank">DevArt Entity Developer </a>as we use that one since it has some nice features. The problem here is the hard-coded schema definition in&nbsp;<b>line 4</b>. Why? Because in the connection string you have to specify the schema name as the <code>User Id</code> like <br /><pre class="brush:xml">&lt;connectionStrings&gt;<br />    &lt;add name="Entities" <br />         connectionString="metadata=res...connection string='User Id=MYSCHEMA;Password=...'"<br />         providerName="System.Data.EntityClient" /&gt;<br />&lt;connectionStrings&gt;<br /></pre>So normally, when we deploy to a different environment, a web.config transformation adapts the <code>User Id</code> for that specific environment like changing <code>MYSCHEMA</code> to <code>MYSCHEMA_TEST</code>. Unfortunately that doesn't work because - remember - the EF configuration file has still <code>MYSCHEMA</code> hardcoded in the configuration file. <br /><h2>    Option 1: Alter session</h2>One option is to execute a command on each connection opening, altering the used session. In Oracle <br /><pre>ALTER SESSION SET CURRENT_SCHEMA=MYSCHEMA_TEST;<br /></pre>The drawback: you execute one additional command on each connection opening. Not probably a big overhead, but still. DevArt supports this starting from version 7 of their dotConnect driver. In there, they added an <code>Initialization Command</code> property defined on the connection string and which lets you specify exactly this alter session command. We currently have v 6.something ... Although we're planning to upgrade probably, I continued to search.<br /><h2>    Option 2: Dynamically adapt the EF Metadata</h2>The idea: Before establishing the connection, load the Entity Framework metadata and exchange the schema name.<br />Browsing around, I found the <a href="http://efmodeladapter.codeplex.com/" target="_blank">Entity Framework Runtime Model Adapter</a> project on Codeplex. That sounds promising. I inspected the code, and it even had a SchemaAdapter which did the job I was looking for. But not exactly. First of all, the project seemed abandoned, with the latest update back in 2010. As a result, it only had support for the (now considered obsolete) <code>ObjectContext</code> rather than <code>DbContext</code> and finally, it adapted an approach of substituting <b>all </b>schema definitions which is not necessarily always desired. <br /><h2> Resulting Solution: Schema Translations</h2><div>So I decided to adapt the code from codeplex s.t. one could define a Schema Translations property in the connection string that looked like</div><pre>Schema Translations=MYSCHEMA-&gt;MYSCHEMA_TEST,ANOTHERSCHEMA-&gt;ANOTHERSCHEMA_STAGING<br /></pre>Advantages of this approach: <br /><ul><li><span style="background-color: white;">Only those schema definitions that have been explicitly specified get substituted while others remain unchanged</span></li><li><span style="background-color: white;">No scary if conditions in the source code to map schema definitions</span></li><li><span style="background-color: white;">Fully configuration based, wherefore web.config transformations work just great</span></li></ul><div>I asked the author of the EFModelAdapter for the permission to publish the modified code on GitHub. Once I get a reply I'll update this post here, detailing my implementation approach. In the mean time, if you have any questions, feel free to leave a comment or contact me.</div>

<h2>//Edit: Uploaded on GitHub</h2>
<p>
I've just uploaded the project on GitHub: <a href="https://github.com/juristr/dbcontext-utils">https://github.com/juristr/dbcontext-utils</a>
</p>
<p>Feel free to submit any comments or pull requests :)</p>